<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Plano de Estudo Completo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Adicione a importação da fonte Inter aqui, se desejar usá-la -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Adicionado: Web App Manifest para PWA -->
  <link rel="manifest" href="manifest.json">
  <!-- Meta tags para iOS (Apple) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="EstudoApp">
  <!-- Ícones para iOS (você deve criar esses arquivos) -->
  <!-- <link rel="apple-touch-icon" href="icons/icon-192x192.png"> -->
  <!-- <link rel="apple-touch-startup-image" href="splash-screen.png"> -->

  <style>
    /* Estilos Gerais - Tema Escuro (Padrão) */
    :root {
        /* Variáveis de Cores - Tema Escuro */
        --bg-primary: #1A202C; /* Fundo azul escuro acinzentado */
        --bg-secondary: #2D3748; /* Fundo de cards/tabelas */
        --bg-tertiary: #242B38; /* Fundo de linhas pares/cronograma dia */
        --bg-header: #1F2937; /* Fundo do cabeçalho/nav */
        --text-primary: #E2E8F0; /* Texto claro */
        --text-secondary: #CBD5E0; /* Texto de navegação */
        --heading-color: #6366F1; /* Índigo vibrante para títulos */
        --border-color-dark: #1A202C; /* Bordas escuras */
        --border-color-light: #2D3748; /* Bordas mais claras */
        --input-border: #4A5568;
        --focus-color: #6366F1;
        --focus-shadow: rgba(99, 102, 241, 0.3);

        /* Cores de Ação */
        --btn-primary: #6366F1;
        --btn-primary-hover: #4F46E5;
        --btn-remove: #EF4444;
        --btn-remove-hover: #DC2626;
        --btn-start: #10B981;
        --btn-start-hover: #059669;
        --btn-pause: #F59E0B;
        --btn-pause-hover: #D97706;
        --btn-resume: #3B82F6;
        --btn-resume-hover: #2563EB;
        --btn-finish: #6366F1; /* Índigo para concluir */
        --btn-finish-hover: #4F46E5;
        --btn-reset: #6B7280;
        --btn-reset-hover: #4B5563;
        --btn-add-slot: #10B981;
        --btn-add-slot-hover: #059669;
        --btn-inc-dec: #1F2937;
        --btn-inc-dec-hover: #2D3748;
        --btn-theme-toggle: #3B82F6;
        --btn-theme-toggle-hover: #2563EB;
        --btn-install-app: #007bff; /* Nova cor para o botão de instalar */
        --btn-install-app-hover: #0056b3;

        /* Cores de Feedback */
        --feedback-success: #10B981;
        --feedback-error: #EF4444;

        /* Cores de Cronômetro */
        --cronometer-active: #6366F1;
        --cronometer-paused: #F59E0B;
        --cronometer-default: #10B981;

        /* Cores de Percentual */
        --percent-high: #10B981;
        --percent-medium: #F59E0B;
        --percent-low: #EF4444;

        /* Cores de Metas */
        --goal-progress-color: #3B82F6; /* Azul para o progresso */
        --goal-remaining-color: #9CA3AF; /* Cinza para o restante */

        /* Cores de Mensagens */
        --message-color: #9CA3AF;

        /* Cores do Calendário */
        --calendar-bg: var(--bg-secondary);
        --calendar-border: var(--border-color-dark);
        --calendar-header-bg: var(--bg-header);
        --calendar-text: var(--text-primary);
        --calendar-day-bg: var(--bg-tertiary);
        --calendar-day-border: var(--border-color-light);
        --calendar-studied-color: var(--percent-high); /* Verde */
        --calendar-not-studied-color: var(--percent-low); /* Vermelho */
        --calendar-default-color: var(--text-secondary); /* Cinza */
        --calendar-today-border: var(--heading-color);
    }

    /* Variáveis de Cores - Tema Claro */
    body.light-theme {
        --bg-primary: #F8FAFC; /* Fundo branco quase cinza */
        --bg-secondary: #FFFFFF; /* Fundo de cards/tabelas */
        --bg-tertiary: #F0F4F8; /* Fundo de linhas pares/cronograma dia */
        --bg-header: #EDF2F7; /* Fundo do cabeçalho/nav */
        --text-primary: #2D3748; /* Texto cinza escuro */
        --text-secondary: #4A5568; /* Texto de navegação */
        --heading-color: #4F46E5; /* Índigo para tema claro */
        --border-color-dark: #E2E8F0; /* Bordas claras */
        --border-color-light: #E2E8F0; /* Bordas mais claras */
        --input-border: #CBD5E0;
        --focus-color: #4F46E5;
        --focus-shadow: rgba(79, 70, 229, 0.2);

        /* Cores de Ação - Tema Claro */
        --btn-primary: #4F46E5;
        --btn-primary-hover: #3730A3;
        --btn-remove: #DC2626;
        --btn-remove-hover: #B91C1C;
        --btn-start: #059669;
        --btn-start-hover: #047857;
        --btn-pause: #D97706;
        --btn-pause-hover: #B45309;
        --btn-resume: #2563EB;
        --btn-resume-hover: #1D4ED8;
        --btn-finish: #4F46E5;
        --btn-finish-hover: #3730A3;
        --btn-reset: #4B5563;
        --btn-reset-hover: #374151;
        --btn-add-slot: #059669;
        --btn-add-slot-hover: #047857;
        --btn-inc-dec: #EDF2F7;
        --btn-inc-dec-hover: #E2E8F0;
        --btn-theme-toggle: #2563EB;
        --btn-theme-toggle-hover: #1D4ED8;
        --btn-install-app: #007bff;
        --btn-install-app-hover: #0056b3;

        /* Cores de Feedback - Tema Claro */
        --feedback-success: #059669;
        --feedback-error: #DC2626;

        /* Cores de Cronômetro - Tema Claro */
        --cronometer-active: #4F46E5;
        --cronometer-paused: #D97706;
        --cronometer-default: #059669;

        /* Cores de Percentual - Tema Claro */
        --percent-high: #059669;
        --percent-medium: #D97706;
        --percent-low: #DC2626;

        /* Cores de Metas - Tema Claro */
        --goal-progress-color: #2563EB; /* Azul para o progresso */
        --goal-remaining-color: #CBD5E0; /* Cinza para o restante */

        /* Cores de Mensagens - Tema Claro */
        --message-color: #6B7280;

        /* Cores do Calendário - Tema Claro */
        --calendar-bg: var(--bg-secondary);
        --calendar-border: var(--border-color-dark);
        --calendar-header-bg: var(--bg-header);
        --calendar-text: var(--text-primary);
        --calendar-day-bg: var(--bg-tertiary);
        --calendar-day-border: var(--border-color-light);
        --calendar-studied-color: var(--percent-high); /* Verde */
        --calendar-not-studied-color: var(--percent-low); /* Vermelho */
        --calendar-default-color: var(--text-secondary); /* Cinza */
        --calendar-today-border: var(--heading-color);
    }

    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    h1, h2, h3 {
      color: var(--heading-color);
      margin-top: 30px;
      border-bottom: 2px solid var(--border-color-light);
      padding-bottom: 10px;
      transition: color 0.3s ease, border-color 0.3s ease;
    }

    h1 {
        font-size: 2.5em;
        text-align: center;
        margin-bottom: 40px;
    }

    h2 {
        font-size: 1.8em;
    }

    h3 {
        font-size: 1.5em;
    }

    /* Estilos de Tabela */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      background-color: var(--bg-secondary);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
      border-radius: 10px;
      overflow: hidden;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    th, td {
      border: 1px solid var(--border-color-dark);
      padding: 12px;
      text-align: center;
      color: var(--text-primary);
      transition: border-color 0.3s ease, color 0.3s ease;
    }

    th {
      background-color: var(--bg-header);
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background-color 0.3s ease;
    }

    tr:nth-child(even) {
      background-color: var(--bg-tertiary);
      transition: background-color 0.3s ease;
    }

    /* Estilos de Input e Select */
    input[type="number"],
    input[type="text"],
    select {
      width: 80px;
      padding: 8px;
      text-align: center;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease, color 0.3s ease;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-repeat: no-repeat;
      background-position: right 8px top 50%;
      background-size: 12px auto;
      padding-right: 25px;
    }

    /* Seta customizada para select - tema escuro */
    select {
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23E2E8F0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.4H18.6c-5%200-9.3%201.8-13.2%206.4-3.9%204.5-6%2010-6%2016.3%200%206.2%202.1%2011.7%206%2016.3l118.4%20118.4c3.9%203.9%209.4%206%2016.3%206s12.4-2.1%2016.3-6L287%20102c3.9-4.5%206-10%206-16.3s-2.1-11.7-6-16.3z%22%2F%3E%3C%2Fsvg%3E');
    }
    /* Seta customizada para select - tema claro */
    body.light-theme select {
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%232D3748%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.4H18.6c-5%200-9.3%201.8-13.2%206.4-3.9%204.5-6%2010-6%2016.3%200%206.2%202.1%2011.7%206%2016.3l118.4%20118.4c3.9%203.9%209.4%206%2016.3%206s12.4-2.1%2016.3-6L287%20102c3.9-4.5%206-10%206-16.3s-2.1-11.7-6-16.3z%22%2F%3E%3C%2Fsvg%3E');
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus {
      border-color: var(--focus-color);
      box-shadow: 0 0 0 3px var(--focus-shadow);
      outline: none;
    }

    /* Estilos de Botão */
    button {
      background-color: var(--btn-primary);
      color: white;
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      margin-top: 10px;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      white-space: nowrap;
    }

    button:hover {
      background-color: var(--btn-primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    button.remove-btn { background-color: var(--btn-remove); }
    button.remove-btn:hover { background-color: var(--btn-remove-hover); }

    button.start-btn { background-color: var(--btn-start); padding: 10px 15px; font-size: 13px; }
    button.start-btn:hover { background-color: var(--btn-start-hover); }

    button.pause-btn { background-color: var(--btn-pause); padding: 10px 15px; font-size: 13px; }
    button.pause-btn:hover { background-color: var(--btn-pause-hover); }

    button.resume-btn { background-color: var(--btn-resume); padding: 10px 15px; font-size: 13px; }
    button.resume-btn:hover { background-color: var(--btn-resume-hover); }

    button.finish-btn { background-color: var(--btn-finish); padding: 10px 15px; font-size: 13px; }
    button.finish-btn:hover { background-color: var(--btn-finish-hover); }

    button.reset-btn { background-color: var(--btn-reset); padding: 10px 15px; font-size: 13px; }
    button.reset-btn:hover { background-color: var(--btn-reset-hover); }

    /* Novo estilo para o botão de instalar PWA */
    button.install-app-btn {
        background-color: var(--btn-install-app);
    }
    button.install-app-btn:hover {
        background-color: var(--btn-install-app-hover);
    }

    /* Contêiner de Gráficos */
    .container {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 40px;
    }

    .chart-container {
      flex: 1 1 45%;
      max-width: 500px;
      min-width: 300px;
      background-color: var(--bg-secondary);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .chart-container canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 420px;
      display: block;
    }

    .chart-container h2 {
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color-dark);
      margin-top: 0;
      padding-bottom: 10px;
      text-align: center;
      transition: color 0.3s ease, border-color 0.3s ease;
    }

    /* Estilos para o gerenciamento de matérias */
    .materia-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .materia-actions input[type="text"] {
      flex-grow: 1;
      width: auto;
    }

    .materia-actions button {
      margin-top: 0;
      padding: 10px 15px;
      font-size: 14px;
    }

    /* Feedback message */
    .feedback-message {
        margin-top: 10px;
        padding: 8px;
        border-radius: 4px;
        font-size: 0.9em;
        text-align: center;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }

    .feedback-message.success { background-color: var(--feedback-success); color: white; }
    .feedback-message.error { background-color: var(--feedback-error); color: white; }

    /* Cronograma Semanal - Layout por dia */
    .cronograma-dia {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      background-color: var(--bg-tertiary);
      border-radius: 8px;
      min-width: 150px;
      transition: background-color 0.3s ease;
    }

    .cronograma-slot {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }

    .cronograma-slot select {
      flex-grow: 1;
      width: auto;
    }

    .cronograma-slot input[type="number"],
    .cronograma-slot input[type="time"] {
      width: 60px; /* Ajuste para inputs de tempo também */
    }

    .no-slots-message {
        color: var(--message-color);
        font-style: italic;
        padding: 10px;
        text-align: center;
    }

    /* Novo estilo para o botão "Adicionar Slot" (ícone +) */
    .add-slot-btn {
      background-color: var(--btn-add-slot);
      color: white;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      padding: 0;
      font-size: 22px;
      line-height: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 8px auto 0;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    }
    .add-slot-btn:hover {
      background-color: var(--btn-add-slot-hover);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
    }
    .add-slot-btn:active {
      transform: translateY(0) scale(1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Estilo para o display do cronômetro */
    .cronometro-display {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 1.2em;
      color: var(--cronometer-default);
      min-width: 90px;
      display: inline-block;
    }

    .cronometro-display.active { color: var(--cronometer-active); font-weight: bold; }
    .cronometro-display.paused { color: var(--cronometer-paused); font-weight: bold; }

    /* Estilo para o contêiner de botões do cronômetro */
    .cronometro-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    /* Estilos para os botões de incremento/decremento */
    .input-with-buttons {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .input-with-buttons input[type="number"] {
        width: 70px;
        flex-grow: 0;
    }
    .input-with-buttons button {
        width: 40px;
        height: 40px;
        padding: 0;
        font-size: 24px;
        line-height: 1;
        margin: 0;
        border-radius: 6px;
        background-color: var(--btn-inc-dec);
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
    }
    .input-with-buttons button:hover {
        background-color: var(--btn-inc-dec-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
    }

    /* Cores para o percentual de acertos */
    .percentual-acertos.high { color: var(--percent-high); }
    .percentual-acertos.medium { color: var(--percent-medium); }
    .percentual-acertos.low { color: var(--percent-low); }

    /* Estilos do Modal (Popup) */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.75);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: var(--bg-secondary);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      width: 90%;
      max-width: 500px;
      transform: translateY(-30px);
      transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-content h3 {
      color: var(--heading-color);
      margin-top: 0;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color-dark);
      padding-bottom: 10px;
      text-align: center;
    }

    .modal-close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 32px;
      cursor: pointer;
      padding: 5px;
      margin: 0;
      transition: color 0.2s ease;
      line-height: 1;
    }

    .modal-close-btn:hover { color: var(--btn-remove); }

    .modal-materia-list {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .modal-materia-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color-dark);
        transition: border-color 0.3s ease;
    }

    .modal-materia-item:last-child { border-bottom: none; }

    .modal-materia-item span {
        flex-grow: 1;
        text-align: left;
        padding-left: 5px;
        color: var(--text-primary);
        transition: color 0.3s ease;
    }

    .modal-materia-item button {
        margin-top: 0;
        padding: 6px 12px;
        font-size: 13px;
    }

    /* Novos estilos para a navegação em abas (escondida por padrão) */
    .tab-navigation {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: var(--bg-header);
      border-top: 1px solid var(--border-color-light);
      justify-content: space-around;
      padding: 10px 0;
      z-index: 999;
      box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .tab-navigation button {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      padding: 8px 5px;
      flex: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      transition: color 0.3s ease, background-color 0.3s ease;
      margin-top: 0;
      box-shadow: none;
      border-radius: 6px;
    }

    .tab-navigation button:hover,
    .tab-navigation button.active {
      color: var(--heading-color);
      background-color: var(--bg-secondary);
    }

    .tab-navigation button.active {
      font-weight: bold;
      font-size: 14px;
    }

    .tab-navigation button i { font-size: 22px; }

    /* Conteúdo das abas (visível por padrão para desktop) */
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Estilos para "cartões" de seção (aplicados sempre, mas mais relevantes em mobile) */
    .section-card {
      background-color: var(--bg-secondary);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
      margin-bottom: 20px;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    /* Estilos para a nova seção de Salvar/Carregar */
    .data-management-section {
      margin-top: 40px;
      padding: 20px;
      background-color: var(--bg-secondary);
      border-radius: 10px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
      text-align: center;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .data-management-section h2 {
      color: var(--heading-color);
      border-bottom: 1px solid var(--border-color-dark);
      margin-top: 0;
      padding-bottom: 10px;
    }

    .data-management-section .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .data-management-section button {
      margin-top: 0;
      padding: 10px 20px;
      font-size: 14px;
    }

    .data-management-section input[type="file"] { display: none; }

    /* Estilos para o modal de configurações */
    #settingsModal .modal-content {
      max-width: 600px;
      padding: 20px;
    }

    #settingsModal .modal-content .section-card {
      background-color: var(--bg-tertiary);
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    #settingsModal .modal-content .section-card:last-child { margin-bottom: 0; }

    #settingsModal .modal-content .section-card h2 {
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color-dark);
      padding-bottom: 8px;
      font-size: 1.2em;
    }

    /* Novo estilo para o gerenciamento de dias do cronograma */
    .cronograma-day-management {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .cronograma-day-management .day-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .cronograma-day-management .day-input-group input[type="text"] {
      flex-grow: 1;
      width: auto;
    }

    .cronograma-day-list {
      max-height: 200px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .cronograma-day-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color-dark);
      color: var(--text-primary);
      transition: border-color 0.3s ease, color 0.3s ease;
    }

    .cronograma-day-item:last-child { border-bottom: none; }

    .cronograma-day-item span {
        flex-grow: 1;
        text-align: left;
        padding-left: 5px;
    }

    .cronograma-day-item button {
      margin-top: 0;
      padding: 6px 12px;
      font-size: 13px;
    }

    /* Estilo para o botão de tema dentro do modal */
    .theme-toggle-button {
        background-color: var(--btn-theme-toggle);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
        flex-grow: 1;
    }

    .theme-toggle-button:hover { background-color: var(--btn-theme-toggle-hover); }
    .theme-toggle-button i { font-size: 18px; }

    /* Ajuste para o span "Alternar Tema" */
    .materia-actions span {
        color: var(--text-primary);
        transition: color 0.3s ease;
    }

    /* Estilos para os novos cartões de matéria (mobile) */
    .materia-card-list {
        display: none;
        flex-direction: column;
        gap: 15px;
    }

    .materia-card {
        background-color: var(--bg-tertiary);
        padding: 18px;
        border-radius: 10px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .materia-card .card-header {
        font-weight: bold;
        color: var(--heading-color);
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid var(--border-color-dark);
        font-size: 1.2em;
        transition: color 0.3s ease, border-color 0.3s ease;
    }

    .materia-card .card-body p {
        margin: 5px 0;
        color: var(--text-primary);
        transition: color 0.3s ease;
    }

    .materia-card .card-body span { font-weight: normal; }

    .materia-card .cronometro-section,
    .materia-card .stats-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        margin-bottom: 10px;
    }

    .materia-card .cronometro-section .cronometro-display {
        flex-grow: 1;
        text-align: left;
    }

    .materia-card .cronometro-actions {
        flex-grow: 1;
        justify-content: flex-end;
    }

    .materia-card .cronometro-actions button {
        width: auto;
        flex-grow: 1;
        min-width: 80px;
    }

    .materia-card .stats-row span {
        flex-basis: 70px;
        text-align: left;
    }

    .materia-card .stats-row .input-with-buttons {
        flex-grow: 1;
        justify-content: flex-start;
    }

    .materia-card .percentual-acertos {
        display: block;
        text-align: right;
        font-weight: bold;
        margin-top: 10px;
    }

    /* Header principal - FIXO NO TOPO */
    .main-header {
      background-color: var(--bg-header);
      padding: 10px 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 999;
    }

    /* Navegação Desktop */
    .desktop-nav {
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .desktop-nav .nav-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 16px;
      padding: 10px 15px;
      cursor: pointer;
      transition: color 0.3s ease, background-color 0.3s ease;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 0;
      box-shadow: none;
    }

    .desktop-nav .nav-btn:hover,
    .desktop-nav .nav-btn.active {
      color: var(--heading-color);
      background-color: var(--bg-secondary);
    }

    /* Pomodoro Timer Section */
    .pomodoro-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        padding: 20px;
        background-color: var(--bg-secondary);
        border-radius: 10px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        margin-bottom: 20px;
    }

    .pomodoro-section h2 {
        margin-top: 0;
        text-align: center;
        border-bottom: 1px solid var(--border-color-dark);
        width: 100%;
    }

    .pomodoro-timer-display {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 3em;
        font-weight: bold;
        color: var(--cronometer-default);
        transition: color 0.3s ease;
    }

    .pomodoro-timer-display.active { color: var(--cronometer-active); }
    .pomodoro-timer-display.paused { color: var(--cronometer-paused); }

    .pomodoro-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .pomodoro-controls button {
        margin-top: 0;
        padding: 10px 20px;
        font-size: 16px;
    }

    .pomodoro-settings {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        width: 100%;
        margin-top: 10px;
    }

    .pomodoro-setting-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }

    .pomodoro-setting-item label {
        color: var(--text-primary);
        font-size: 0.9em;
    }

    .pomodoro-setting-item input {
        width: 80px;
        text-align: center;
    }

    /* Metas de Estudo */
    .goals-section {
        padding: 20px;
        background-color: var(--bg-secondary);
        border-radius: 10px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        margin-bottom: 20px;
    }

    .goals-section h2 {
        margin-top: 0;
        text-align: center;
        border-bottom: 1px solid var(--border-color-dark);
        width: 100%;
    }

    .goal-item {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color-dark);
    }

    .goal-item:last-child {
        border-bottom: none;
    }

    .goal-item select, .goal-item input[type="number"] {
        flex-grow: 1;
        min-width: 100px;
    }

    .goal-item .goal-progress {
        flex-basis: 100%;
        margin-top: 5px;
        font-size: 0.9em;
        color: var(--text-primary);
    }

    .goal-item .goal-progress span {
        font-weight: bold;
        color: var(--cronometer-default);
    }

    /* Estilos para o Calendário */
    .calendar-container {
        background-color: var(--calendar-bg);
        border-radius: 10px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        padding: 20px;
        margin-top: 20px;
        text-align: center;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--calendar-border);
    }

    .calendar-header button {
        background: none;
        border: none;
        color: var(--heading-color);
        font-size: 1.5em;
        cursor: pointer;
        padding: 5px;
        margin: 0;
        box-shadow: none;
    }

    .calendar-header h3 {
        margin: 0;
        color: var(--heading-color);
        border-bottom: none;
        padding-bottom: 0;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }

    .calendar-day-name {
        font-weight: bold;
        color: var(--text-secondary);
        padding: 8px 0;
        border-bottom: 1px solid var(--calendar-border);
    }

    .calendar-day {
        background-color: var(--calendar-day-bg);
        border: 1px solid var(--calendar-day-border);
        border-radius: 5px;
        padding: 10px 5px;
        min-height: 60px; /* Para manter o tamanho consistente */
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        font-size: 0.9em;
        color: var(--calendar-text);
        cursor: pointer;
        transition: background-color 0.2s ease, border-color 0.2s ease;
        position: relative;
        overflow: hidden; /* Para esconder o overflow das bolinhas */
    }

    .calendar-day.empty {
        background-color: transparent;
        border-color: transparent;
        cursor: default;
    }

    .calendar-day.today {
        border: 2px solid var(--calendar-today-border);
        font-weight: bold;
    }

    .calendar-day .day-number {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 5px;
        color: var(--text-primary);
    }

    .calendar-day .discipline-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        flex-shrink: 0; /* Evita que as bolinhas encolham */
    }

    .discipline-status.studied { background-color: var(--calendar-studied-color); }
    .discipline-status.not-studied { background-color: var(--calendar-not-studied-color); }

    .calendar-day-details {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9); /* Fundo escuro para o popup */
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 10px;
        box-sizing: border-box;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        z-index: 10;
    }

    .calendar-day:hover .calendar-day-details {
        opacity: 1;
        visibility: visible;
    }

    .calendar-day-details p {
        margin: 2px 0;
        font-size: 0.8em;
        text-align: left;
        width: 100%;
    }
    .calendar-day-details .status-icon {
        margin-right: 5px;
    }


    /* Responsividade */
    @media (max-width: 768px) {
      body {
        padding: 10px 10px 70px 10px; /* Aumenta o padding inferior para a nav bar */
      }
      h1 {
        font-size: 2em;
        margin-bottom: 20px;
      }
      .container {
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }
      .chart-container {
        width: 95%;
        max-width: none;
      }
      .table-responsive-wrapper {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        width: 100%;
        margin: 15px 0;
      }
      table {
        width: 100%;
        min-width: auto;
        margin: 0;
      }
      th, td {
        font-size: 12px;
        padding: 8px;
        white-space: normal;
        word-break: break-word;
      }
      #cronogramaTable th, #cronogramaTable td {
        min-width: auto;
        width: 50%;
        vertical-align: top;
      }
      .cronograma-dia {
        min-width: auto;
        width: 100%;
      }
      .cronograma-slot {
        flex-wrap: wrap;
        justify-content: flex-start;
        flex-direction: column;
        align-items: stretch;
        padding: 8px;
        border: 1px solid var(--bg-tertiary);
        border-radius: 6px;
        margin-bottom: 8px;
      }
      .cronograma-slot:last-of-type { margin-bottom: 0; }
      .cronograma-slot select {
        width: 100%;
        margin-bottom: 8px;
        font-size: 1em;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .cronograma-slot input[type="number"],
      .cronograma-slot input[type="time"] {
        width: 100%;
        margin-bottom: 8px;
      }
      .cronograma-slot button.remove-btn {
        width: 100%;
        margin-top: 5px;
      }

      .cronometro-actions button {
        width: 100%;
        margin-top: 0;
      }
      .materia-actions {
        flex-direction: column;
        align-items: stretch;
      }
      .materia-actions button { width: 100%; }
      .materia-actions input[type="text"] { width: 100%; }
      .modal-content { padding: 20px; }

      .tab-navigation {
        display: flex;
        justify-content: space-around; /* Ajuste para distribuir os itens */
        padding: 8px 0; /* Reduzir padding */
      }
      .tab-navigation button {
        flex: 1; /* Distribuir igualmente */
        max-width: 20%; /* Limitar largura para evitar quebra */
        font-size: 11px; /* Reduzir tamanho da fonte */
        padding: 6px 3px; /* Reduzir padding */
      }
      .tab-navigation button i { font-size: 18px; } /* Reduzir tamanho do ícone */

      /* Esconder botões específicos na navegação inferior para mobile */
      #tabBtnMetas, #tabBtnPomodoro, #tabBtnHistorico {
        display: none;
      }
      /* Mostrar o botão "Mais" */
      #tabBtnMore {
        display: flex;
      }

      .tab-content { padding-bottom: 0; }
      .tab-content h2 { display: none; } /* Esconde os h2 das abas no mobile */

      .input-with-buttons {
        width: 100%;
        justify-content: center;
      }
      .input-with-buttons input[type="number"] {
        flex-grow: 1;
        max-width: 80px;
      }

      .data-management-section .button-group { flex-direction: column; }
      .data-management-section button { width: 100%; }

      .theme-toggle-button { width: 100%; }
      .materia-actions span {
        width: 100%;
        text-align: center;
        margin-bottom: 5px;
      }

      #horasTable, #questoesTable { display: none; } /* Esconde tabelas no mobile */
      .materia-card-list { display: flex; } /* Mostra cartões no mobile */
      .main-header { display: none; } /* Esconde o header desktop no mobile */

      .pomodoro-settings {
          flex-direction: column;
          align-items: stretch;
      }
      .pomodoro-setting-item {
          align-items: stretch;
      }
      .pomodoro-setting-item input {
          width: 100%;
      }
      .goal-item {
          flex-direction: column;
          align-items: stretch;
      }
      .goal-item select, .goal-item input[type="number"] {
          width: 100%;
          min-width: auto;
      }
      .goal-item button {
          width: 100%;
      }

      /* Ajustes para o modal de configurações no mobile */
      #settingsModal .modal-content {
        width: 95%;
        max-width: none;
        margin: 10px;
      }
      #settingsModal .modal-content .section-card {
        padding: 15px;
      }
      #settingsModal .modal-content h2 {
        font-size: 1.5em; /* Ajusta o tamanho do h2 dentro do modal */
        border-bottom: 1px solid var(--border-color-dark);
        padding-bottom: 8px;
        margin-bottom: 15px;
      }
      /* Esconde a aba de histórico principal no mobile, pois ela estará no modal */
      #historicoTab { display: none !important; }

      /* Estilos para o novo modal de "Mais Opções" */
      #moreOptionsModal .modal-content {
        max-width: 300px; /* Menor para mobile */
        padding: 15px;
      }
      #moreOptionsModal .modal-content .button-group {
        flex-direction: column;
        gap: 8px;
      }
      #moreOptionsModal .modal-content .button-group button {
        width: 100%;
        padding: 10px;
        font-size: 14px;
      }
    }

    /* Ajustes para desktop (min-width: 769px) */
    @media (min-width: 769px) {
      body { padding-top: 80px; }
      .tab-navigation { display: none; } /* Esconde a navegação inferior no desktop */
      .desktop-nav { display: flex; } /* Mostra a navegação superior no desktop */
      .tab-content h2 { display: block !important; } /* Mostra os h2 das abas no desktop */
      #horasTable, #questoesTable { display: table; } /* Mostra tabelas no desktop */
      .materia-card-list { display: none; } /* Esconde cartões no desktop */
      #historicoTab { display: block !important; } /* Garante que a aba de histórico seja visível no desktop */
    }
  </style>
</head>
<body>
  <header class="main-header">
    <nav class="desktop-nav">
      <button id="desktopTabBtnCronograma" class="nav-btn" onclick="App.UI.showTab('cronogramaTab', this)"><i class="fas fa-calendar-alt"></i> Cronograma</button>
      <button id="desktopTabBtnHoras" class="nav-btn" onclick="App.UI.showTab('horasTab', this)"><i class="fas fa-clock"></i> Horas</button>
      <button id="desktopTabBtnQuestoes" class="nav-btn" onclick="App.UI.showTab('questoesTab', this)"><i class="fas fa-question-circle"></i> Questões</button>
      <button id="desktopTabBtnMetas" class="nav-btn" onclick="App.UI.showTab('metasTab', this)"><i class="fas fa-bullseye"></i> Metas</button>
      <button id="desktopTabBtnPomodoro" class="nav-btn" onclick="App.UI.showTab('pomodoroTab', this)"><i class="fas fa-hourglass-half"></i> Pomodoro</button>
      <button id="desktopTabBtnGraficos" class="nav-btn" onclick="App.UI.showTab('graficosTab', this)"><i class="fas fa-chart-bar"></i> Gráficos</button>
      <button id="desktopTabBtnHistorico" class="nav-btn" onclick="App.UI.showTab('historicoTab', this)"><i class="fas fa-history"></i> Histórico</button>
      <button id="desktopTabBtnSettings" class="nav-btn settings-nav-btn" onclick="App.UI.openSettingsModal('settings')"><i class="fas fa-cog"></i> Configurações</button>
    </nav>
  </header>

  <h1>Plano de Estudo Completo</h1>

  <!-- Conteúdo principal das abas -->
  <div id="cronogramaTab" class="tab-content">
    <div class="section-card">
      <h2>Cronograma Semanal</h2>
      <!-- Wrapper para rolagem horizontal da tabela -->
      <div class="table-responsive-wrapper">
        <table id="cronogramaTable">
          <thead>
            <tr>
              <th>Dia</th>
              <th>Slots de Estudo</th>
            </tr>
          </thead>
          <tbody>
            <!-- Conteúdo gerado por JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="horasTab" class="tab-content">
    <div class="section-card">
      <h2>Total de Horas por Conteúdo</h2>
      <!-- Tabela para desktop -->
      <div class="table-responsive-wrapper">
        <table id="horasTable">
          <thead>
            <tr><th>Matéria</th><th>Total de Horas (min)</th><th>Cronômetro</th><th>Ações</th></tr>
          </thead>
          <tbody>
            <!-- Conteúdo gerado por JS -->
          </tbody>
        </table>
      </div>
      <!-- Lista de cartões para mobile -->
      <div id="horasCardList" class="materia-card-list">
        <!-- Conteúdo gerado por JS -->
      </div>
    </div>
  </div>

  <div id="questoesTab" class="tab-content">
    <div class="section-card">
      <h2>Questões (Acertos x Erros)</h2>
      <!-- Tabela para desktop -->
      <div class="table-responsive-wrapper">
        <table id="questoesTable">
          <thead>
            <tr><th>Matéria</th><th>Acertos</th><th>Erros</th><th>% Acertos</th></tr>
          </thead>
          <tbody>
            <!-- Conteúdo gerado por JS -->
          </tbody>
        </table>
      </div>
      <!-- Lista de cartões para mobile -->
      <div id="questoesCardList" class="materia-card-list">
        <!-- Conteúdo gerado por JS -->
      </div>
    </div>
  </div>

  <div id="metasTab" class="tab-content">
    <div class="goals-section section-card">
        <h2>Minhas Metas de Estudo</h2>
        <p class="no-slots-message" style="opacity: 1; font-style: normal; color: var(--text-secondary);">
            As horas de estudo e os ciclos do Pomodoro são resetados automaticamente todo domingo às 23:59:59.
        </p>
        <div class="materia-actions">
            <select id="goalMateriaSelect">
                <!-- Opções de matéria geradas por JS -->
            </select>
            <input type="number" id="goalTargetHours" placeholder="Horas/Semana" min="1">
            <button onclick="App.Goals.addGoal()">Adicionar Meta</button>
        </div>
        <div id="goalFeedback" class="feedback-message"></div>
        <div id="goalsList">
            <!-- Metas serão renderizadas aqui -->
        </div>
    </div>
  </div>

  <div id="pomodoroTab" class="tab-content">
    <div class="pomodoro-section section-card">
        <h2>Pomodoro Timer</h2>
        <div class="pomodoro-setting-item">
            <label for="pomodoroMateriaSelect">Matéria:</label>
            <select id="pomodoroMateriaSelect" onchange="App.Pomodoro.updateSettings()">
                <!-- Opções de matéria geradas por JS -->
            </select>
        </div>
        <div id="pomodoroTimerDisplay" class="pomodoro-timer-display">25:00</div>
        <div class="pomodoro-controls">
            <button id="pomodoroStartBtn" onclick="App.Pomodoro.startPomodoro()"><i class="fas fa-play"></i> Iniciar</button>
            <button id="pomodoroPauseBtn" style="display:none;" onclick="App.Pomodoro.pausePomodoro()"><i class="fas fa-pause"></i> Pausar</button>
            <button id="pomodoroResumeBtn" style="display:none;" onclick="App.Pomodoro.resumePomodoro()"><i class="fas fa-play"></i> Continuar</button>
            <button id="pomodoroResetBtn" onclick="App.Pomodoro.resetPomodoro()"><i class="fas fa-redo"></i> Zerar</button>
            <button id="pomodoroSkipBtn" style="display:none;" onclick="App.Pomodoro.skipPhase()"><i class="fas fa-forward"></i> Pular</button>
        </div>
        <div class="pomodoro-settings">
            <div class="pomodoro-setting-item">
                <label for="studyDuration">Estudo (min):</label>
                <input type="number" id="studyDuration" value="25" min="1" onchange="App.Pomodoro.updateSettings()">
            </div>
            <div class="pomodoro-setting-item">
                <label for="shortBreakDuration">Pausa Curta (min):</label>
                <input type="number" id="shortBreakDuration" value="5" min="1" onchange="App.Pomodoro.updateSettings()">
            </div>
            <div class="pomodoro-setting-item">
                <label for="longBreakDuration">Pausa Longa (min):</label>
                <input type="number" id="longBreakDuration" value="15" min="1" onchange="App.Pomodoro.updateSettings()">
            </div>
            <div class="pomodoro-setting-item">
                <label for="longBreakInterval">Intervalo Pausa Longa:</label>
                <input type="number" id="longBreakInterval" value="4" min="1" onchange="App.Pomodoro.updateSettings()">
            </div>
        </div>
        <div id="pomodoroFeedback" class="feedback-message"></div>
    </div>
  </div>

  <div id="graficosTab" class="tab-content">
    <div class="section-card">
      <h2>Gráficos</h2>
      <div class="container">
        <div class="chart-container">
          <h2>Horas por Matéria</h2>
          <canvas id="chartHoras"></canvas>
        </div>
        <div class="chart-container">
          <h2>Acertos x Erros</h2>
          <canvas id="chartQuestoes"></canvas>
        </div>
        <div class="chart-container">
            <h2>Progresso das Metas</h2>
            <canvas id="chartMetas"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Aba de Histórico (visível apenas em desktop) -->
  <div id="historicoTab" class="tab-content">
    <div class="section-card">
        <h2>Histórico de Estudo por Dia</h2>
        <div class="calendar-container">
            <div class="calendar-header">
                <button onclick="App.Calendar.changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <h3 id="currentMonthYear"></h3>
                <button onclick="App.Calendar.changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div id="calendarGrid" class="calendar-grid">
                <!-- Dias da semana e dias do mês serão gerados aqui -->
            </div>
        </div>
    </div>
  </div>

  <!-- Modal de Configurações (agora inclui Histórico para mobile) -->
  <div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="App.UI.closeSettingsModal()">&times;</button>
      <h3>Configurações</h3>

      <!-- Navegação interna do modal para mobile -->
      <div class="tab-navigation" style="display: flex; position: static; box-shadow: none; border-top: none; margin-bottom: 20px;">
        <button id="modalTabBtnSettings" class="nav-btn active" onclick="App.UI.showModalSection('settingsSection', this)">
          <i class="fas fa-cog"></i>
          <span>Geral</span>
        </button>
        <button id="modalTabBtnHistory" class="nav-btn" onclick="App.UI.showModalSection('historySectionModal', this)">
          <i class="fas fa-history"></i>
          <span>Histórico</span>
        </button>
      </div>

      <!-- Seção de Configurações Gerais (visível por padrão no modal) -->
      <div id="settingsSection" class="modal-section active">
        <!-- Opção de Tema -->
        <div class="section-card">
          <h2>Tema</h2>
          <div class="materia-actions">
            <span>Alternar Tema:</span>
            <button class="theme-toggle-button" onclick="App.Theme.toggleTheme()">
              <i class="fas fa-sun"></i> / <i class="fas fa-moon"></i>
            </button>
          </div>
        </div>

        <!-- Gerenciamento de Matérias Base -->
        <div class="section-card">
          <h2>Gerenciar Matérias Base</h2>
          <div class="materia-actions">
            <input type="text" id="novaMateriaNome" placeholder="Nome da nova matéria">
            <button onclick="App.MateriaManager.addMateriaBase()">Adicionar Matéria</button>
          </div>
          <div id="materiaFeedback" class="feedback-message"></div>
          <div id="modalMateriasList" class="modal-materia-list">
            <!-- Matérias base serão renderizadas aqui pelo JS no modal -->
          </div>
        </div>

        <!-- Seção para Salvar/Carregar Progresso -->
        <div class="data-management-section section-card">
          <h2>Gerenciar Dados</h2>
          <div class="button-group">
            <button onclick="App.DataManager.saveProgressJSON()">
              <i class="fas fa-download"></i> Salvar Progresso
            </button>
            <input type="file" id="uploadJsonInput" accept=".json" onchange="App.DataManager.loadProgressJSON(event)">
            <button onclick="document.getElementById('uploadJsonInput').click()">
              <i class="fas fa-upload"></i> Carregar Progresso
            </button>
            <!-- Adicionado: Botão de Instalar PWA -->
            <button id="installAppButton" class="install-app-btn" style="display:none;">
                <i class="fas fa-mobile-alt"></i> Instalar App
            </button>
          </div>
          <div id="dataFeedback" class="feedback-message"></div>
        </div>
      </div>

      <!-- Seção de Histórico (dentro do modal, visível apenas em mobile) -->
      <div id="historySectionModal" class="modal-section" style="display: none;">
        <h2>Histórico de Estudo por Dia</h2>
        <div class="calendar-container">
            <div class="calendar-header">
                <button onclick="App.Calendar.changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <h3 id="currentMonthYearModal"></h3>
                <button onclick="App.Calendar.changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div id="calendarGridModal" class="calendar-grid">
                <!-- Dias da semana e dias do mês serão gerados aqui -->
            </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Novo Modal para "Mais Opções" (Metas, Pomodoro, Histórico) -->
  <div id="moreOptionsModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="App.UI.closeMoreOptionsModal()">&times;</button>
      <h3>Mais Opções</h3>
      <div class="button-group">
        <button onclick="App.UI.showTab('metasTab', this); App.UI.closeMoreOptionsModal();">
          <i class="fas fa-bullseye"></i> Metas
        </button>
        <button onclick="App.UI.showTab('pomodoroTab', this); App.UI.closeMoreOptionsModal();">
          <i class="fas fa-hourglass-half"></i> Pomodoro
        </button>
        <button onclick="App.UI.showTab('historicoTab', this); App.UI.closeMoreOptionsModal();">
          <i class="fas fa-history"></i> Histórico
        </button>
      </div>
    </div>
  </div>


  <!-- Navegação em Abas (para mobile/tablet) -->
  <div class="tab-navigation">
    <button id="tabBtnCronograma" onclick="App.UI.showTab('cronogramaTab', this)">
      <i class="fas fa-calendar-alt"></i>
      <span>Cronograma</span>
    </button>
    <button id="tabBtnHoras" onclick="App.UI.showTab('horasTab', this)">
      <i class="fas fa-clock"></i>
      <span>Horas</span>
    </button>
    <button id="tabBtnQuestoes" onclick="App.UI.showTab('questoesTab', this)">
      <i class="fas fa-question-circle"></i>
      <span>Questões</span>
    </button>
    <button id="tabBtnGraficos" onclick="App.UI.showTab('graficosTab', this)">
      <i class="fas fa-chart-bar"></i>
      <span>Gráficos</span>
    </button>
    <button id="tabBtnSettings" onclick="App.UI.openSettingsModal('settings')">
      <i class="fas fa-cog"></i>
      <span>Config.</span>
    </button>
    <button id="tabBtnMore" onclick="App.UI.openMoreOptionsModal()">
      <i class="fas fa-ellipsis-h"></i>
      <span>Mais</span>
    </button>
    <!-- As abas abaixo serão movidas para o modal "Mais Opções" no mobile -->
    <button id="tabBtnMetas" style="display:none;" onclick="App.UI.showTab('metasTab', this)">
        <i class="fas fa-bullseye"></i>
        <span>Metas</span>
    </button>
    <button id="tabBtnPomodoro" style="display:none;" onclick="App.UI.showTab('pomodoroTab', this)">
        <i class="fas fa-hourglass-half"></i>
        <span>Pomodoro</span>
    </button>
    <button id="tabBtnHistorico" style="display:none;" onclick="App.UI.showTab('historicoTab', this)">
        <i class="fas fa-history"></i>
        <span>Histórico</span>
    </button>
  </div>

<script>
  // Objeto global para encapsular toda a lógica da aplicação
  const App = {
    // --- Dados da Aplicação ---
    data: {
      materiasBase: [
        { nome: 'Português', totalHoras: 0, acertos: 0, erros: 0 },
        { nome: 'Penal Processual', totalHoras: 0, acertos: 0, erros: 0 },
        { nome: 'Direito Penal', totalHoras: 0, acertos: 0, erros: 0 },
        { nome: 'Direitos Humanos', totalHoras: 0, acertos: 0, erros: 0 },
        { nome: 'Legislação', totalHoras: 0, acertos: 0, erros: 0 },
        { nome: 'Raciocínio Lógico', totalHoras: 0, acertos: 0, erros: 0 },
        { nome: 'Informática', totalHoras: 0, acertos: 0, erros: 0 },
        { nome: 'Constitucional', totalHoras: 0, acertos: 0, erros: 0 },
        { nome: 'Administrativo', totalHoras: 0, acertos: 0, erros: 0 }
      ],
      cronogramaSemanal: {}, // { "Dia": [{materia: "Nome", duracao: 60, tipo: "minutos" | "horario", inicio: "HH:MM", fim: "HH:MM"}] }
      // Dias da semana pré-definidos para consistência
      diasDaSemanaPadrao: ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'],
      theme: 'dark',
      pomodoroSettings: {
        studyDuration: 25,
        shortBreakDuration: 5,
        longBreakDuration: 15,
        longBreakInterval: 4,
        cyclesCompleted: 0,
        selectedMateria: '' // Novo: Matéria selecionada para o Pomodoro
      },
      goals: [], // [{ materia: "Nome", targetHours: 10 }]
      dailyStudyLog: {} // Novo: { 'YYYY-MM-DD': { 'MateriaA': true, 'MateriaB': true } }
    },

    // --- Variáveis de Estado do Cronômetro de Estudo ---
    activeStudyTimer: {
      interval: null,
      materiaNome: null,
      displayElement: null,
      startTime: 0,
      pausedTime: 0,
      isPaused: false
    },

    // --- Variáveis de Estado do Pomodoro Timer ---
    pomodoroTimer: {
      interval: null,
      currentPhase: 'study', // 'study', 'shortBreak', 'longBreak'
      timeLeft: 0, // em milissegundos
      isPaused: false,
      cyclesCompletedInSession: 0, // Ciclos completos desde o último reset do pomodoro
      displayElement: null
    },

    // --- Gráficos ---
    charts: {
      chartHoras: null,
      chartQuestoes: null,
      chartMetas: null
    },

    // --- Variável para o evento beforeinstallprompt ---
    deferredInstallPrompt: null,

    // --- Utilitários ---
    Utils: {
        /** Obtém o valor computado de uma variável CSS. */
        getCssVariable(variableName) {
            return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
        },
        /** Formata uma data para YYYY-MM-DD. */
        formatDateToYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        },
        /** Obtém o nome do dia da semana em português. */
        getDayName(dayIndex) {
            const days = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
            return days[dayIndex];
        }
    },

    // --- Módulo de Gerenciamento de Dados ---
    DataManager: {
      /** Salva os dados da aplicação no localStorage. */
      saveData() {
        localStorage.setItem('planilhaEstudoData', JSON.stringify(App.data));
      },

      /** Carrega os dados da aplicação do localStorage. */
      loadData() {
        const savedData = localStorage.getItem('planilhaEstudoData');
        if (savedData) {
          const parsedData = JSON.parse(savedData);

          // Carrega matérias base, garantindo propriedades padrão
          App.data.materiasBase = parsedData.materiasBase || [];
          App.data.materiasBase.forEach(materia => {
            materia.totalHoras = materia.totalHoras || 0;
            materia.acertos = materia.acertos || 0;
            materia.erros = materia.erros || 0;
          });

          // Carrega cronograma semanal e garante que todos os dias padrão existam
          App.data.cronogramaSemanal = parsedData.cronogramaSemanal || {};
          App.data.diasDaSemanaPadrao.forEach(diaPadrao => {
              if (!App.data.cronogramaSemanal[diaPadrao]) {
                  App.data.cronogramaSemanal[diaPadrao] = [];
              }
              // Garante que os slots tenham matéria, duracao e tipo (com fallback)
              App.data.cronogramaSemanal[diaPadrao] = App.data.cronogramaSemanal[diaPadrao].map(slot => ({
                materia: slot.materia || '',
                duracao: slot.duracao || 0,
                tipo: slot.tipo || 'minutos',
                inicio: slot.inicio || '',
                fim: slot.fim || ''
              }));
          });


          // Carrega o tema
          App.data.theme = parsedData.theme || 'dark';

          // Carrega configurações do Pomodoro
          App.data.pomodoroSettings = {
            studyDuration: parsedData.pomodoroSettings?.studyDuration || 25,
            shortBreakDuration: parsedData.pomodoroSettings?.shortBreakDuration || 5,
            longBreakDuration: parsedData.pomodoroSettings?.longBreakDuration || 15,
            longBreakInterval: parsedData.pomodoroSettings?.longBreakInterval || 4,
            cyclesCompleted: parsedData.pomodoroSettings?.cyclesCompleted || 0, // Total de ciclos concluídos
            selectedMateria: parsedData.pomodoroSettings?.selectedMateria || '' // Novo: Matéria selecionada
          };

          // Carrega metas
          App.data.goals = parsedData.goals || [];
          App.data.goals.forEach(goal => {
              goal.materia = goal.materia || '';
              goal.targetHours = goal.targetHours || 0;
          });

          // Carrega o log de estudo diário
          App.data.dailyStudyLog = parsedData.dailyStudyLog || {};

        } else {
          // Se não houver dados salvos, inicializa cronograma com dias padrão
          App.data.cronogramaSemanal = {};
          App.data.diasDaSemanaPadrao.forEach(diaPadrao => {
              App.data.cronogramaSemanal[diaPadrao] = [];
          });
          App.data.goals = [];
          App.data.dailyStudyLog = {};
          App.DataManager.saveData(); // Salva essa inicialização
        }
      },

      /** Salva o progresso atual em um arquivo JSON e o baixa. */
      saveProgressJSON() {
        const dataToSave = JSON.stringify(App.data, null, 2);
        const blob = new Blob([dataToSave], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'plano_estudo_progresso.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        App.UI.showFeedback('Progresso salvo com sucesso!', 'success', 'dataFeedback');
      },

      /** Carrega o progresso de um arquivo JSON selecionado pelo usuário. */
      loadProgressJSON(event) {
        const file = event.target.files[0];
        if (!file) {
          App.UI.showFeedback('Nenhum arquivo selecionado.', 'error', 'dataFeedback');
          return;
        }

        if (file.type !== 'application/json') {
          App.UI.showFeedback('Por favor, selecione um arquivo JSON válido.', 'error', 'dataFeedback');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const loadedData = JSON.parse(e.target.result);

            // Validação mais robusta da estrutura do JSON
            const isValid = loadedData.materiasBase && Array.isArray(loadedData.materiasBase) &&
                            loadedData.cronogramaSemanal && typeof loadedData.cronogramaSemanal === 'object' &&
                            // Removido: loadedData.diasCadastrados && Array.isArray(loadedData.diasCadastrados) &&
                            loadedData.pomodoroSettings && typeof loadedData.pomodoroSettings === 'object' &&
                            loadedData.goals && Array.isArray(loadedData.goals) &&
                            loadedData.dailyStudyLog && typeof loadedData.dailyStudyLog === 'object';

            if (!isValid) {
                App.UI.showFeedback('Estrutura do arquivo JSON inválida. Certifique-se de que é um arquivo de progresso válido.', 'error', 'dataFeedback');
                return;
            }

            if (!confirm('Tem certeza que deseja carregar este progresso? O progresso atual será substituído.')) {
              App.UI.showFeedback('Carregamento cancelado.', 'error', 'dataFeedback');
              return;
            }

            App.data = loadedData;
            // Garante que todas as propriedades padrão existam após o carregamento
            App.data.materiasBase.forEach(materia => {
                materia.totalHoras = materia.totalHoras || 0;
                materia.acertos = materia.acertos || 0;
                materia.erros = materia.erros || 0;
            });
            // Garante que todos os dias padrão existam no cronograma após o carregamento
            App.data.diasDaSemanaPadrao.forEach(diaPadrao => {
                if (!App.data.cronogramaSemanal[diaPadrao]) {
                    App.data.cronogramaSemanal[diaPadrao] = [];
                }
                App.data.cronogramaSemanal[diaPadrao] = App.data.cronogramaSemanal[diaPadrao].map(slot => ({
                    materia: slot.materia || '',
                    duracao: slot.duracao || 0,
                    tipo: slot.tipo || 'minutos',
                    inicio: slot.inicio || '',
                    fim: slot.fim || ''
                }));
            });
            App.data.pomodoroSettings = {
                studyDuration: App.data.pomodoroSettings.studyDuration || 25,
                shortBreakDuration: App.data.pomodoroSettings.shortBreakDuration || 5,
                longBreakDuration: App.data.pomodoroSettings.longBreakDuration || 15,
                longBreakInterval: App.data.pomodoroSettings.longBreakInterval || 4,
                cyclesCompleted: App.data.pomodoroSettings.cyclesCompleted || 0,
                selectedMateria: App.data.pomodoroSettings.selectedMateria || '' // Garante que a matéria selecionada exista
            };
            App.data.goals.forEach(goal => {
                goal.materia = goal.materia || '';
                goal.targetHours = goal.targetHours || 0;
            });
            App.data.dailyStudyLog = App.data.dailyStudyLog || {}; // Garante que o log diário exista


            App.Theme.applyTheme(App.data.theme);
            App.DataManager.saveData(); // Salva os dados carregados no localStorage
            App.UI.renderAll(); // Re-renderiza toda a UI
            App.Charts.updateCharts();
            App.UI.showFeedback('Progresso carregado com sucesso!', 'success', 'dataFeedback');
          } catch (error) {
            console.error('Erro ao parsear JSON:', error);
            App.UI.showFeedback('Erro ao carregar o arquivo JSON. Verifique o formato.', 'error', 'dataFeedback');
          } finally {
            event.target.value = ''; // Limpa o input de arquivo
          }
        };
        reader.readAsText(file);
      }
    },

    // --- Módulo de Gerenciamento de Matérias ---
    MateriaManager: {
      /** Retorna uma lista de matérias ativas (com dados ou no cronograma). */
      getMateriasAtivas() {
        return App.data.materiasBase.filter(materia => {
          const isInCronograma = Object.values(App.data.cronogramaSemanal).some(slots =>
            slots.some(slot => slot.materia === materia.nome)
          );
          const isInGoals = App.data.goals.some(goal => goal.materia === materia.nome);
          // Verifica também se a matéria tem algum registro no dailyStudyLog
          const isInDailyLog = Object.values(App.data.dailyStudyLog).some(dayLog => dayLog[materia.nome]);
          return isInCronograma || isInGoals || materia.totalHoras > 0 || materia.acertos > 0 || materia.erros > 0 || isInDailyLog;
        });
      },

      /** Adiciona uma nova matéria à lista de matérias base. */
      addMateriaBase() {
        const novaMateriaNomeInput = document.getElementById('novaMateriaNome');
        const nome = novaMateriaNomeInput.value.trim();

        if (nome) {
          if (!App.data.materiasBase.some(m => m.nome.toLowerCase() === nome.toLowerCase())) {
            App.data.materiasBase.push({
              nome: nome,
              totalHoras: 0,
              acertos: 0,
              erros: 0
            });
            novaMateriaNomeInput.value = '';
            App.DataManager.saveData();
            App.UI.renderAll(); // Re-renderiza toda a UI
            App.Charts.updateCharts();
            App.UI.showFeedback(`Matéria "${nome}" adicionada com sucesso!`, 'success', 'materiaFeedback');
          } else {
            App.UI.showFeedback('Matéria já existe!', 'error', 'materiaFeedback');
          }
        } else {
          App.UI.showFeedback('Por favor, digite o nome da matéria.', 'error', 'materiaFeedback');
        }
      },

      /** Remove uma matéria da lista de matérias base e de todos os cronogramas. */
      removeMateriaBase(materiaNome) {
        if (confirm(`Tem certeza que deseja remover a matéria "${materiaNome}"? Isso removerá todos os dados associados.`)) {
          if (App.activeStudyTimer.materiaNome === materiaNome) {
              App.StudyTimer.concluirEstudo(materiaNome); // Conclui o estudo se a matéria estiver ativa no cronômetro
          }
          // Se a matéria removida for a selecionada no Pomodoro, reseta a seleção
          if (App.data.pomodoroSettings.selectedMateria === materiaNome) {
              App.data.pomodoroSettings.selectedMateria = '';
              App.Pomodoro.resetPomodoro(); // Reseta o pomodoro se a matéria ativa for removida
          }


          App.data.materiasBase = App.data.materiasBase.filter(m => m.nome !== materiaNome);

          // Remove a matéria do cronograma
          Object.keys(App.data.cronogramaSemanal).forEach(dia => {
            App.data.cronogramaSemanal[dia] = App.data.cronogramaSemanal[dia].filter(slot => slot.materia !== materiaNome);
          });

          // Remove a matéria das metas
          App.data.goals = App.data.goals.filter(goal => goal.materia !== materiaNome);

          // Remove a matéria do dailyStudyLog
          Object.keys(App.data.dailyStudyLog).forEach(date => {
              if (App.data.dailyStudyLog[date][materiaNome]) {
                  delete App.data.dailyStudyLog[date][materiaNome];
                  // Se o dia não tiver mais matérias estudadas, pode remover a entrada do dia
                  if (Object.keys(App.data.dailyStudyLog[date]).length === 0) {
                      delete App.data.dailyStudyLog[date];
                  }
              }
          });


          App.DataManager.saveData();
          App.UI.renderAll(); // Re-renderiza toda a UI
          App.Charts.updateCharts();
          App.UI.showFeedback(`Matéria "${materiaNome}" removida com sucesso!`, 'success', 'materiaFeedback');
        }
      }
    },

    // --- Módulo de Cronograma ---
    Cronograma: {
      /** Renderiza a tabela do cronograma semanal. */
      renderCronograma() {
        const tbody = document.querySelector('#cronogramaTable tbody');
        tbody.innerHTML = '';

        // Sempre usa os dias da semana padrão
        App.data.diasDaSemanaPadrao.forEach(dia => {
          const row = tbody.insertRow();
          row.insertCell().textContent = dia;

          const slotsCell = row.insertCell();
          const diaContainer = document.createElement('div');
          diaContainer.className = 'cronograma-dia';
          diaContainer.id = `cronograma-dia-${dia.replace(/\s/g, '-')}`;

          const slotsForDay = App.data.cronogramaSemanal[dia] || [];

          if (slotsForDay.length === 0) {
              const noSlotsMessage = document.createElement('p');
              noSlotsMessage.className = 'no-slots-message';
              noSlotsMessage.textContent = 'Nenhum slot adicionado para este dia.';
              diaContainer.appendChild(noSlotsMessage);
          } else {
              slotsForDay.forEach((slot, slotIndex) => {
                diaContainer.appendChild(App.Cronograma.createCronogramaSlot(dia, slotIndex, slot));
              });
          }

          const addSlotBtn = document.createElement('button');
          addSlotBtn.textContent = '+';
          addSlotBtn.className = 'add-slot-btn';
          addSlotBtn.onclick = () => App.Cronograma.addCronogramaSlot(dia);
          diaContainer.appendChild(addSlotBtn);

          slotsCell.appendChild(diaContainer);
        });
      },

      /** Cria e retorna um elemento de slot de cronograma. */
      createCronogramaSlot(dia, slotIndex, slotData) {
        const slotDiv = document.createElement('div');
        slotDiv.className = 'cronograma-slot';
        slotDiv.dataset.dia = dia;
        slotDiv.dataset.slotIndex = slotIndex;

        const selectMateria = document.createElement('select');
        if (App.data.materiasBase.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Nenhuma matéria';
            selectMateria.appendChild(option);
            selectMateria.disabled = true;
        } else {
            App.data.materiasBase.forEach(materia => {
                const option = document.createElement('option');
                option.value = materia.nome;
                option.textContent = materia.nome;
                selectMateria.appendChild(option);
            });
            selectMateria.value = slotData.materia || App.data.materiasBase[0].nome;
        }

        selectMateria.addEventListener('change', (e) => {
          App.data.cronogramaSemanal[dia][slotIndex].materia = e.target.value;
          App.DataManager.saveData();
          App.UI.renderAll();
          App.Charts.updateCharts();
        });
        slotDiv.appendChild(selectMateria);

        // Tipo de slot: minutos ou horário
        const selectTipo = document.createElement('select');
        ['minutos', 'horario'].forEach(tipo => {
            const option = document.createElement('option');
            option.value = tipo;
            option.textContent = tipo.charAt(0).toUpperCase() + tipo.slice(1);
            selectTipo.appendChild(option);
        });
        selectTipo.value = slotData.tipo;
        selectTipo.addEventListener('change', (e) => {
            App.data.cronogramaSemanal[dia][slotIndex].tipo = e.target.value;
            App.DataManager.saveData();
            App.Cronograma.renderCronograma(); // Re-renderiza para mostrar/esconder inputs
        });
        slotDiv.appendChild(selectTipo);

        if (slotData.tipo === 'minutos') {
            const inputDuracao = document.createElement('input');
            inputDuracao.type = 'number';
            inputDuracao.min = '0';
            inputDuracao.placeholder = 'min';
            inputDuracao.value = slotData.duracao;
            inputDuracao.addEventListener('change', (e) => {
              App.data.cronogramaSemanal[dia][slotIndex].duracao = Number(e.target.value);
              App.DataManager.saveData();
            });
            slotDiv.appendChild(inputDuracao);
        } else { // tipo === 'horario'
            const inputInicio = document.createElement('input');
            inputInicio.type = 'time';
            inputInicio.value = slotData.inicio || '09:00';
            inputInicio.addEventListener('change', (e) => {
                App.data.cronogramaSemanal[dia][slotIndex].inicio = e.target.value;
                App.DataManager.saveData();
            });
            slotDiv.appendChild(inputInicio);

            const inputFim = document.createElement('input');
            inputFim.type = 'time';
            inputFim.value = slotData.fim || '10:00';
            inputFim.addEventListener('change', (e) => {
                App.data.cronogramaSemanal[dia][slotIndex].fim = e.target.value;
                App.DataManager.saveData();
            });
            slotDiv.appendChild(inputFim);
        }


        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'X';
        removeBtn.className = 'remove-btn';
        removeBtn.style.padding = '6px 10px';
        removeBtn.style.fontSize = '12px';
        removeBtn.style.marginTop = '0';
        removeBtn.onclick = () => App.Cronograma.removeCronogramaSlot(dia, slotIndex);
        slotDiv.appendChild(removeBtn);

        return slotDiv;
      },

      /** Adiciona um novo slot de estudo para um dia específico. */
      addCronogramaSlot(dia) {
        if (App.data.materiasBase.length === 0) {
            App.UI.showFeedback('Por favor, adicione pelo menos uma matéria base antes de criar um slot de estudo.', 'error', 'materiaFeedback');
            return;
        }
        if (!App.data.cronogramaSemanal[dia]) {
          App.data.cronogramaSemanal[dia] = [];
        }
        const newSlot = { materia: App.data.materiasBase[0].nome, duracao: 60, tipo: 'minutos', inicio: '', fim: '' };
        App.data.cronogramaSemanal[dia].push(newSlot);
        App.DataManager.saveData();
        App.Cronograma.renderCronograma();
        App.UI.renderHorasTable();
        App.UI.renderQuestoesTable();
        App.Charts.updateCharts();
        App.Calendar.renderCalendar(); // Atualiza o calendário
      },

      /** Remove um slot de estudo de um dia específico. */
      removeCronogramaSlot(dia, slotIndex) {
        App.data.cronogramaSemanal[dia].splice(slotIndex, 1);
        App.DataManager.saveData();
        App.Cronograma.renderCronograma();
        App.UI.renderHorasTable();
        App.UI.renderQuestoesTable();
        App.Charts.updateCharts();
        App.Calendar.renderCalendar(); // Atualiza o calendário
      },
    },

    // --- Módulo de Cronômetro de Estudo ---
    StudyTimer: {
      /** Formata o tempo em milissegundos para HH:MM:SS. */
      formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      },

      /** Atualiza os botões e classes do cronômetro na UI. */
      updateUIForCronometer(materiaName, isActive, isPaused) {
          const tableDisplay = document.getElementById(`cronometro-${materiaName.replace(/\s/g, '-')}`);
          const cardDisplay = document.getElementById(`card-cronometro-${materiaName.replace(/\s/g, '-')}`);

          const tableActions = document.getElementById(`actions-table-${materiaName.replace(/\s/g, '-')}`);
          const cardActions = document.getElementById(`actions-card-${materiaName.replace(/\s/g, '-')}`);

          [tableDisplay, cardDisplay].forEach(displayElem => {
              if (displayElem) {
                  displayElem.classList.remove('active', 'paused');
                  if (isActive) {
                      displayElem.classList.add(isPaused ? 'paused' : 'active');
                  }
              }
          });

          [tableActions, cardActions].forEach(actionsContainer => {
              if (actionsContainer) {
                  actionsContainer.querySelector('.start-btn').style.display = isActive ? 'none' : 'inline-block';
                  actionsContainer.querySelector('.pause-btn').style.display = (isActive && !isPaused) ? 'inline-block' : 'none';
                  actionsContainer.querySelector('.resume-btn').style.display = (isActive && isPaused) ? 'inline-block' : 'none';
                  actionsContainer.querySelector('.finish-btn').style.display = isActive ? 'inline-block' : 'none';
                  actionsContainer.querySelector('.reset-btn').style.display = 'inline-block';
              }
          });
      },

      /** Inicia o cronômetro para uma matéria. */
      iniciarEstudo(materiaNome, displayElement) {
        if (App.activeStudyTimer.interval && App.activeStudyTimer.materiaNome !== materiaNome) {
            App.UI.showFeedback(`O estudo de "${App.activeStudyTimer.materiaNome}" está ativo. Por favor, pause ou conclua-o antes de iniciar outro.`, 'error', 'materiaFeedback');
            return;
        }
        if (App.activeStudyTimer.interval && App.activeStudyTimer.materiaNome === materiaNome && !App.activeStudyTimer.isPaused) {
            return;
        }

        clearInterval(App.activeStudyTimer.interval);

        if (App.activeStudyTimer.materiaNome !== materiaNome || App.activeStudyTimer.pausedTime === 0) {
            App.activeStudyTimer.pausedTime = 0;
        }

        App.activeStudyTimer.materiaNome = materiaNome;
        App.activeStudyTimer.displayElement = displayElement;
        App.activeStudyTimer.startTime = Date.now();
        App.activeStudyTimer.isPaused = false;

        App.data.materiasBase.forEach(materia => {
            if (materia.nome !== materiaNome) {
                App.StudyTimer.updateUIForCronometer(materia.nome, false, false);
            }
        });

        App.StudyTimer.updateUIForCronometer(materiaNome, true, false);

        App.activeStudyTimer.interval = setInterval(() => {
          const elapsedTime = Date.now() - App.activeStudyTimer.startTime + App.activeStudyTimer.pausedTime;
          const formattedTime = App.StudyTimer.formatTime(elapsedTime);

          if (App.activeStudyTimer.displayElement) {
              App.activeStudyTimer.displayElement.textContent = formattedTime;
          }

          const otherDisplayElementId = App.activeStudyTimer.displayElement.id.startsWith('card-')
            ? App.activeStudyTimer.displayElement.id.replace('card-cronometro-', 'cronometro-')
            : App.activeStudyTimer.displayElement.id.replace('cronometro-', 'card-cronometro-');
          const otherDisplayElement = document.getElementById(otherDisplayElementId);
          if (otherDisplayElement && otherDisplayElement !== App.activeStudyTimer.displayElement) {
              otherDisplayElement.textContent = formattedTime;
          }
        }, 1000);
      },

      /** Pausa o cronômetro para a matéria ativa. */
      pausarEstudo(materiaNome) {
        if (App.activeStudyTimer.materiaNome !== materiaNome || App.activeStudyTimer.isPaused) {
            return;
        }

        clearInterval(App.activeStudyTimer.interval);
        App.activeStudyTimer.interval = null;
        App.activeStudyTimer.pausedTime += (Date.now() - App.activeStudyTimer.startTime);
        App.activeStudyTimer.isPaused = true;

        App.StudyTimer.updateUIForCronometer(materiaNome, true, true);
      },

      /** Continua o cronômetro para a matéria ativa. */
      continuarEstudo(materiaNome) {
        if (App.activeStudyTimer.materiaNome !== materiaNome || !App.activeStudyTimer.isPaused) {
            return;
        }

        App.activeStudyTimer.startTime = Date.now();
        App.activeStudyTimer.isPaused = false;

        App.StudyTimer.updateUIForCronometer(materiaNome, true, false);

        App.activeStudyTimer.interval = setInterval(() => {
          const elapsedTime = Date.now() - App.activeStudyTimer.startTime + App.activeStudyTimer.pausedTime;
          const formattedTime = App.StudyTimer.formatTime(elapsedTime);

          if (App.activeStudyTimer.displayElement) {
              App.activeStudyTimer.displayElement.textContent = formattedTime;
          }

          const otherDisplayElementId = App.activeStudyTimer.displayElement.id.startsWith('card-')
            ? App.activeStudyTimer.displayElement.id.replace('card-cronometro-', 'cronometro-')
            : App.activeStudyTimer.displayElement.id.replace('cronometro-', 'card-cronometro-');
          const otherDisplayElement = document.getElementById(otherDisplayElementId);
          if (otherDisplayElement && otherDisplayElement !== App.activeStudyTimer.displayElement) {
              otherDisplayElement.textContent = formattedTime;
          }
        }, 1000);
      },

      /** Conclui o estudo para a matéria ativa, salva o tempo e reseta o cronômetro. */
      concluirEstudo(materiaNome) {
        if (App.activeStudyTimer.materiaNome !== materiaNome) {
            return;
        }

        clearInterval(App.activeStudyTimer.interval);
        App.activeStudyTimer.interval = null;

        const totalElapsedTimeMs = App.activeStudyTimer.pausedTime + (Date.now() - App.activeStudyTimer.startTime);
        const elapsedTimeMinutes = Math.round(totalElapsedTimeMs / (1000 * 60));

        const materia = App.data.materiasBase.find(m => m.nome === materiaNome);
        if (materia) {
          materia.totalHoras += elapsedTimeMinutes;

          // Registrar no dailyStudyLog
          const today = App.Utils.formatDateToYYYYMMDD(new Date());
          if (!App.data.dailyStudyLog[today]) {
              App.data.dailyStudyLog[today] = {};
          }
          App.data.dailyStudyLog[today][materiaNome] = true; // Marca como estudada no dia

          App.DataManager.saveData();
          App.UI.showFeedback(`Estudo de "${materiaNome}" concluído! ${elapsedTimeMinutes} min adicionados.`, 'success', 'materiaFeedback');
        }

        App.activeStudyTimer.materiaNome = null;
        App.activeStudyTimer.displayElement = null;
        App.activeStudyTimer.startTime = 0;
        App.activeStudyTimer.pausedTime = 0;
        App.activeStudyTimer.isPaused = false;

        App.UI.renderHorasTable();
        App.Charts.updateCharts();
        App.Calendar.renderCalendar(); // Atualiza o calendário após concluir estudo
      },

      /** Zera o tempo de estudo de uma matéria específica. */
      resetarEstudo(materiaNome) {
        if (confirm(`Tem certeza que deseja zerar o tempo de estudo de "${materiaNome}"?`)) {
          const materia = App.data.materiasBase.find(m => m.nome === materiaNome);
          if (materia) {
            if (App.activeStudyTimer.materiaNome === materiaNome) {
              clearInterval(App.activeStudyTimer.interval);
              App.activeStudyTimer.interval = null;
              App.activeStudyTimer.materiaNome = null;
              App.activeStudyTimer.displayElement = null;
              App.activeStudyTimer.startTime = 0;
              App.activeStudyTimer.pausedTime = 0;
              App.activeStudyTimer.isPaused = false;
            }

            materia.totalHoras = 0;
            App.DataManager.saveData();
            App.UI.showFeedback(`Tempo de estudo de "${materiaNome}" zerado com sucesso!`, 'success', 'materiaFeedback');
            App.UI.renderHorasTable();
            App.Charts.updateCharts();
          }
        }
      }
    },

    // --- Módulo de Questões ---
    Questoes: {
      /** Atualiza o número de acertos de uma matéria. */
      updateAcertos(materiaNome, delta, newValue = null) {
        const materia = App.data.materiasBase.find(m => m.nome === materiaNome);
        if (materia) {
          if (newValue !== null) {
            materia.acertos = Math.max(0, Number(newValue));
          } else {
            materia.acertos = Math.max(0, materia.acertos + delta);
          }
          App.DataManager.saveData();
          App.UI.renderQuestoesTable();
          App.Charts.updateCharts();
        }
      },

      /** Atualiza o número de erros de uma matéria. */
      updateErros(materiaNome, delta, newValue = null) {
        const materia = App.data.materiasBase.find(m => m.nome === materiaNome);
        if (materia) {
          if (newValue !== null) {
            materia.erros = Math.max(0, Number(newValue));
          } else {
            materia.erros = Math.max(0, materia.erros + delta);
          }
          App.DataManager.saveData();
          App.UI.renderQuestoesTable();
          App.Charts.updateCharts();
        }
      }
    },

    // --- Módulo de Metas ---
    Goals: {
        /** Renderiza a lista de metas de estudo. */
        renderGoals() {
            const goalsListDiv = document.getElementById('goalsList');
            goalsListDiv.innerHTML = '';

            const goalMateriaSelect = document.getElementById('goalMateriaSelect');
            goalMateriaSelect.innerHTML = '<option value="">Selecione a Matéria</option>';
            App.data.materiasBase.forEach(materia => {
                const option = document.createElement('option');
                option.value = materia.nome;
                option.textContent = materia.nome;
                goalMateriaSelect.appendChild(option);
            });

            if (App.data.goals.length === 0) {
                goalsListDiv.innerHTML = '<p class="no-slots-message">Nenhuma meta adicionada.</p>';
                return;
            }

            App.data.goals.forEach((goal, index) => {
                const materia = App.data.materiasBase.find(m => m.nome === goal.materia);
                const currentHours = materia ? materia.totalHoras : 0;
                const targetMinutes = goal.targetHours * 60;
                const progress = (currentHours / targetMinutes) * 100;
                const progressText = `${currentHours} min / ${targetMinutes} min (${progress.toFixed(2)}%)`;

                const goalItem = document.createElement('div');
                goalItem.className = 'goal-item';
                goalItem.innerHTML = `
                    <span>${goal.materia}:</span>
                    <input type="number" value="${goal.targetHours}" min="1" onchange="App.Goals.updateGoal('${goal.materia}', this.value)">
                    <span>horas/semana</span>
                    <button class="remove-btn" onclick="App.Goals.removeGoal('${goal.materia}')">Remover</button>
                    <p class="goal-progress">Progresso: <span>${progressText}</span></p>
                `;
                goalsListDiv.appendChild(goalItem);
            });
        },

        /** Adiciona uma nova meta de estudo. */
        addGoal() {
            const materiaNome = document.getElementById('goalMateriaSelect').value;
            const targetHours = Number(document.getElementById('goalTargetHours').value);

            if (!materiaNome) {
                App.UI.showFeedback('Por favor, selecione uma matéria.', 'error', 'goalFeedback');
                return;
            }
            if (targetHours <= 0) {
                App.UI.showFeedback('A meta de horas deve ser um número positivo.', 'error', 'goalFeedback');
                return;
            }
            if (App.data.goals.some(g => g.materia === materiaNome)) {
                App.UI.showFeedback('Já existe uma meta para esta matéria.', 'error', 'goalFeedback');
                return;
            }

            App.data.goals.push({ materia: materiaNome, targetHours: targetHours });
            App.DataManager.saveData();
            App.Goals.renderGoals();
            App.Charts.updateCharts();
            App.UI.showFeedback(`Meta para "${materiaNome}" adicionada!`, 'success', 'goalFeedback');
            document.getElementById('goalMateriaSelect').value = '';
            document.getElementById('goalTargetHours').value = '';
        },

        /** Atualiza uma meta existente. */
        updateGoal(materiaNome, newTargetHours) {
            const goal = App.data.goals.find(g => g.materia === materiaNome);
            if (goal) {
                goal.targetHours = Math.max(1, Number(newTargetHours));
                App.DataManager.saveData();
                App.Goals.renderGoals();
                App.Charts.updateCharts();
            }
        },

        /** Remove uma meta de estudo. */
        removeGoal(materiaNome) {
            if (confirm(`Tem certeza que deseja remover a meta para "${materiaNome}"?`)) {
                App.data.goals = App.data.goals.filter(g => g.materia !== materiaNome);
                App.DataManager.saveData();
                App.Goals.renderGoals();
                App.Charts.updateCharts();
                App.UI.showFeedback(`Meta para "${materiaNome}" removida!`, 'success', 'goalFeedback');
            }
        },

        /** Agenda o reset semanal das horas de estudo e ciclos do Pomodoro. */
        scheduleWeeklyReset() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Domingo, 1 = Segunda, ..., 6 = Sábado
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            // Condição para resetar: Domingo, 23:59:59
            if (dayOfWeek === 0 && hours === 23 && minutes === 59 && seconds === 59) {
                const lastResetDate = localStorage.getItem('lastWeeklyResetDate');
                const today = App.Utils.formatDateToYYYYMMDD(now);

                if (lastResetDate !== today) { // Garante que resete apenas uma vez por dia
                    App.Goals.performWeeklyReset();
                    localStorage.setItem('lastWeeklyResetDate', today);
                }
            }

            // Agenda a próxima verificação para o próximo segundo
            setTimeout(() => App.Goals.scheduleWeeklyReset(), 1000);
        },

        /** Executa o reset das horas de estudo e ciclos do Pomodoro. */
        performWeeklyReset() {
            // Resetar as horas de estudo e ciclos do Pomodoro
            App.data.materiasBase.forEach(materia => {
                materia.totalHoras = 0;
            });
            App.data.pomodoroSettings.cyclesCompleted = 0;

            App.DataManager.saveData();
            App.UI.renderAll();
            App.Charts.updateCharts();
            App.UI.showFeedback('Metas semanais e ciclos do Pomodoro resetados automaticamente!', 'success', 'goalFeedback');
            console.log('Reset semanal automático realizado.');
        }
    },

    // --- Módulo Pomodoro Timer ---
    Pomodoro: {
        /** Inicializa o display do Pomodoro com as configurações atuais. */
        initPomodoroDisplay() {
            App.pomodoroTimer.displayElement = document.getElementById('pomodoroTimerDisplay');
            App.Pomodoro.renderMateriaSelect(); // Renderiza o select de matéria
            App.Pomodoro.resetPomodoro(false); // Resetar sem feedback inicial
            App.Pomodoro.updateSettingsUI();
        },

        /** Renderiza as opções de matéria no select do Pomodoro. */
        renderMateriaSelect() {
            const pomodoroMateriaSelect = document.getElementById('pomodoroMateriaSelect');
            pomodoroMateriaSelect.innerHTML = '<option value="">Selecione a Matéria</option>';
            App.data.materiasBase.forEach(materia => {
                const option = document.createElement('option');
                option.value = materia.nome;
                option.textContent = materia.nome;
                pomodoroMateriaSelect.appendChild(option);
            });
            // Define o valor selecionado com base nos dados salvos
            pomodoroMateriaSelect.value = App.data.pomodoroSettings.selectedMateria;
        },

        /** Atualiza as configurações do Pomodoro a partir dos inputs. */
        updateSettings() {
            App.data.pomodoroSettings.studyDuration = Number(document.getElementById('studyDuration').value) || 25;
            App.data.pomodoroSettings.shortBreakDuration = Number(document.getElementById('shortBreakDuration').value) || 5;
            App.data.pomodoroSettings.longBreakDuration = Number(document.getElementById('longBreakDuration').value) || 15;
            App.data.pomodoroSettings.longBreakInterval = Number(document.getElementById('longBreakInterval').value) || 4;
            App.data.pomodoroSettings.selectedMateria = document.getElementById('pomodoroMateriaSelect').value; // Salva a matéria selecionada
            App.DataManager.saveData();
            App.Pomodoro.resetPomodoro(); // Resetar o timer com as novas configurações
            App.UI.showFeedback('Configurações do Pomodoro atualizadas!', 'success', 'pomodoroFeedback');
        },

        /** Atualiza os inputs de configuração do Pomodoro com os valores salvos. */
        updateSettingsUI() {
            document.getElementById('studyDuration').value = App.data.pomodoroSettings.studyDuration;
            document.getElementById('shortBreakDuration').value = App.data.pomodoroSettings.shortBreakDuration;
            document.getElementById('longBreakDuration').value = App.data.pomodoroSettings.longBreakDuration;
            document.getElementById('longBreakInterval').value = App.data.pomodoroSettings.longBreakInterval;
            document.getElementById('pomodoroMateriaSelect').value = App.data.pomodoroSettings.selectedMateria;
        },

        /** Inicia ou continua o Pomodoro. */
        startPomodoro() {
            if (App.pomodoroTimer.interval) return; // Já está rodando

            const selectedMateria = App.data.pomodoroSettings.selectedMateria;
            if (!selectedMateria && App.pomodoroTimer.currentPhase === 'study') {
                App.UI.showFeedback('Por favor, selecione uma matéria para iniciar o Pomodoro.', 'error', 'pomodoroFeedback');
                return;
            }

            App.pomodoroTimer.isPaused = false;
            App.pomodoroTimer.displayElement.classList.add('active');
            App.pomodoroTimer.displayElement.classList.remove('paused');

            document.getElementById('pomodoroStartBtn').style.display = 'none';
            document.getElementById('pomodoroPauseBtn').style.display = 'inline-block';
            document.getElementById('pomodoroResumeBtn').style.display = 'none';
            document.getElementById('pomodoroSkipBtn').style.display = 'inline-block';

            if (App.pomodoroTimer.timeLeft === 0) {
                // Inicia uma nova fase
                App.pomodoroTimer.currentPhase = 'study';
                App.pomodoroTimer.timeLeft = App.data.pomodoroSettings.studyDuration * 60 * 1000;
                App.UI.showFeedback('Fase de Estudo iniciada!', 'success', 'pomodoroFeedback');
            } else {
                // Continua de onde parou (se não estava pausado, isso não deveria acontecer)
                App.UI.showFeedback('Pomodoro retomado!', 'success', 'pomodoroFeedback');
            }

            App.pomodoroTimer.interval = setInterval(() => {
                App.pomodoroTimer.timeLeft -= 1000;
                if (App.pomodoroTimer.timeLeft <= 0) {
                    App.Pomodoro.nextPhase();
                } else {
                    App.pomodoroTimer.displayElement.textContent = App.StudyTimer.formatTime(App.pomodoroTimer.timeLeft);
                }
            }, 1000);
        },

        /** Pausa o Pomodoro. */
        pausePomodoro() {
            if (!App.pomodoroTimer.interval) return;

            clearInterval(App.pomodoroTimer.interval);
            App.pomodoroTimer.interval = null;
            App.pomodoroTimer.isPaused = true;
            App.pomodoroTimer.displayElement.classList.remove('active');
            App.pomodoroTimer.displayElement.classList.add('paused');

            document.getElementById('pomodoroStartBtn').style.display = 'none';
            document.getElementById('pomodoroPauseBtn').style.display = 'none';
            document.getElementById('pomodoroResumeBtn').style.display = 'inline-block';
            document.getElementById('pomodoroSkipBtn').style.display = 'inline-block';

            App.UI.showFeedback('Pomodoro pausado.', 'error', 'pomodoroFeedback');
        },

        /** Retoma o Pomodoro de onde parou. */
        resumePomodoro() {
            if (!App.pomodoroTimer.isPaused) return;
            App.Pomodoro.startPomodoro();
        },

        /** Reseta o Pomodoro para o estado inicial. */
        resetPomodoro(showMsg = true) {
            clearInterval(App.pomodoroTimer.interval);
            App.pomodoroTimer.interval = null;
            App.pomodoroTimer.currentPhase = 'study';
            App.pomodoroTimer.timeLeft = App.data.pomodoroSettings.studyDuration * 60 * 1000;
            App.pomodoroTimer.isPaused = false;
            App.pomodoroTimer.cyclesCompletedInSession = 0; // Resetar ciclos da sessão

            App.pomodoroTimer.displayElement.textContent = App.StudyTimer.formatTime(App.pomodoroTimer.timeLeft);
            App.pomodoroTimer.displayElement.classList.remove('active', 'paused');

            document.getElementById('pomodoroStartBtn').style.display = 'inline-block';
            document.getElementById('pomodoroPauseBtn').style.display = 'none';
            document.getElementById('pomodoroResumeBtn').style.display = 'none';
            document.getElementById('pomodoroSkipBtn').style.display = 'none';

            if (showMsg) {
                App.UI.showFeedback('Pomodoro zerado.', 'error', 'pomodoroFeedback');
            }
        },

        /** Pula para a próxima fase do Pomodoro. */
        skipPhase() {
            clearInterval(App.pomodoroTimer.interval);
            App.pomodoroTimer.interval = null;
            App.Pomodoro.nextPhase(true); // Força a próxima fase
        },

        /** Avança para a próxima fase do ciclo Pomodoro. */
        nextPhase(skipped = false) {
            clearInterval(App.pomodoroTimer.interval);
            App.pomodoroTimer.interval = null;

            let nextPhaseDuration = 0;
            let feedbackMessage = '';

            // Se a fase atual for de estudo, contabiliza o tempo e marca no log
            if (App.pomodoroTimer.currentPhase === 'study') {
                const selectedMateria = App.data.pomodoroSettings.selectedMateria;
                if (selectedMateria) {
                    const materia = App.data.materiasBase.find(m => m.nome === selectedMateria);
                    if (materia) {
                        const studyDurationMinutes = App.data.pomodoroSettings.studyDuration;
                        materia.totalHoras += studyDurationMinutes;

                        // Registrar no dailyStudyLog
                        const today = App.Utils.formatDateToYYYYMMDD(new Date());
                        if (!App.data.dailyStudyLog[today]) {
                            App.data.dailyStudyLog[today] = {};
                        }
                        App.data.dailyStudyLog[today][selectedMateria] = true; // Marca como estudada no dia
                    }
                }
                App.pomodoroTimer.cyclesCompletedInSession++;
                App.data.pomodoroSettings.cyclesCompleted++; // Incrementa o total de ciclos concluídos
                App.DataManager.saveData(); // Salva o novo total de ciclos
                App.UI.renderHorasTable(); // Atualiza a tabela de horas
                App.Charts.updateCharts(); // Atualiza os gráficos
                App.Calendar.renderCalendar(); // Atualiza o calendário
            }


            if (App.pomodoroTimer.currentPhase === 'study') {
                if (App.pomodoroTimer.cyclesCompletedInSession % App.data.pomodoroSettings.longBreakInterval === 0) {
                    App.pomodoroTimer.currentPhase = 'longBreak';
                    nextPhaseDuration = App.data.pomodoroSettings.longBreakDuration;
                    feedbackMessage = 'Pausa Longa!';
                } else {
                    App.pomodoroTimer.currentPhase = 'shortBreak';
                    nextPhaseDuration = App.data.pomodoroSettings.shortBreakDuration;
                    feedbackMessage = 'Pausa Curta!';
                }
            } else { // Se for uma pausa, o próximo é estudo
                App.pomodoroTimer.currentPhase = 'study';
                nextPhaseDuration = App.data.pomodoroSettings.studyDuration;
                feedbackMessage = 'Fase de Estudo!';
            }

            App.pomodoroTimer.timeLeft = nextPhaseDuration * 60 * 1000;
            App.pomodoroTimer.displayElement.textContent = App.StudyTimer.formatTime(App.pomodoroTimer.timeLeft);
            App.pomodoroTimer.displayElement.classList.remove('active', 'paused');

            document.getElementById('pomodoroStartBtn').style.display = 'inline-block';
            document.getElementById('pomodoroPauseBtn').style.display = 'none';
            document.getElementById('pomodoroResumeBtn').style.display = 'none';
            document.getElementById('pomodoroSkipBtn').style.display = 'none'; // Esconde o botão pular até iniciar

            if (skipped) {
                App.UI.showFeedback(`Fase pulada. Próxima: ${feedbackMessage}`, 'success', 'pomodoroFeedback');
            } else {
                App.UI.showFeedback(`Tempo esgotado! Próxima: ${feedbackMessage}`, 'success', 'pomodoroFeedback');
                // Tocar um som de notificação
                const audio = new Audio('https://www.soundjay.com/buttons/beep-07.mp3'); // Exemplo de som
                audio.play().catch(e => console.error("Erro ao tocar som:", e));
            }
        }
    },

    // --- Módulo de Gráficos ---
    Charts: {
      chartHoras: null,
      chartQuestoes: null,
      chartMetas: null,

      /** Atualiza os gráficos com os dados atuais. */
      updateCharts() {
        const materiasAtivas = App.MateriaManager.getMateriasAtivas();

        const materiasLabels = materiasAtivas.map(m => m.nome);
        const horasData = materiasAtivas.map(m => m.totalHoras);
        const acertosData = materiasAtivas.map(m => m.acertos);
        const errosData = materiasAtivas.map(m => m.erros);

        // Obter cores do CSS em tempo de execução
        const textColor = App.Utils.getCssVariable('--text-primary');
        const gridColor = App.Utils.getCssVariable('--border-color-light');
        const headingColor = App.Utils.getCssVariable('--heading-color');
        const percentHighColor = App.Utils.getCssVariable('--percent-high');
        const percentLowColor = App.Utils.getCssVariable('--percent-low');
        const goalProgressColor = App.Utils.getCssVariable('--goal-progress-color');
        const goalRemainingColor = App.Utils.getCssVariable('--goal-remaining-color');


        // Gráfico de Horas
        if (App.charts.chartHoras) App.charts.chartHoras.destroy();
        App.charts.chartHoras = new Chart(document.getElementById('chartHoras'), {
          type: 'bar',
          data: {
            labels: materiasLabels,
            datasets: [{
              label: 'Total de Horas (minutos)',
              data: horasData,
              backgroundColor: headingColor,
              borderColor: headingColor,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
              x: { ticks: { color: textColor }, grid: { color: gridColor } }
            },
            plugins: {
              legend: { labels: { color: textColor } },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) { label += ': '; }
                    if (context.parsed.y !== null) { label += context.parsed.y + ' min'; }
                    return label;
                  }
                }
              }
            }
          }
        });

        // Gráfico de Questões
        if (App.charts.chartQuestoes) App.charts.chartQuestoes.destroy();
        App.charts.chartQuestoes = new Chart(document.getElementById('chartQuestoes'), {
          type: 'bar',
          data: {
            labels: materiasLabels,
            datasets: [
              { label: 'Acertos', data: acertosData, backgroundColor: percentHighColor, borderColor: percentHighColor, borderWidth: 1 },
              { label: 'Erros', data: errosData, backgroundColor: percentLowColor, borderColor: percentLowColor, borderWidth: 1 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
              x: { ticks: { color: textColor }, grid: { color: gridColor } }
            },
            plugins: {
              legend: { labels: { color: textColor } },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) { label += ': '; }
                    if (context.parsed.y !== null) { label += context.parsed.y + ' questões'; }
                    return label;
                  }
                }
              }
            }
          }
        });

        // Gráfico de Metas (Barra Horizontal de Progresso)
        const goalLabels = App.data.goals.map(g => g.materia);
        const goalProgressData = App.data.goals.map(g => {
            const materia = App.data.materiasBase.find(m => m.nome === g.materia);
            return materia ? materia.totalHoras : 0; // Horas estudadas em minutos
        });
        const goalRemainingData = App.data.goals.map(g => {
            const materia = App.data.materiasBase.find(m => m.nome === g.materia);
            const currentHours = materia ? materia.totalHoras : 0;
            const targetMinutes = g.targetHours * 60;
            return Math.max(0, targetMinutes - currentHours); // Meta restante em minutos
        });

        if (App.charts.chartMetas) App.charts.chartMetas.destroy();
        App.charts.chartMetas = new Chart(document.getElementById('chartMetas'), {
            type: 'bar',
            data: {
                labels: goalLabels,
                datasets: [
                    {
                        label: 'Progresso Atual (min)',
                        data: goalProgressData,
                        backgroundColor: percentHighColor, // Usar a cor verde (percent-high)
                        borderColor: percentHighColor,
                        borderWidth: 1
                    },
                    {
                        label: 'Meta Restante (min)',
                        data: goalRemainingData,
                        backgroundColor: goalRemainingColor,
                        borderColor: goalRemainingColor,
                        borderWidth: 1
                    }
                ]
            },
            options: {
                indexAxis: 'y', // Torna o gráfico de barras horizontal
                responsive: true,
                maintainAspectRatio: false,
                barThickness: 10, // Torna a barra mais fina (ajuste o valor conforme preferir)
                categoryPercentage: 0.8, // Espaçamento entre as categorias
                barPercentage: 0.9, // Largura da barra dentro da categoria
                scales: {
                    x: {
                        stacked: true, // Empilha as barras no eixo X
                        beginAtZero: true,
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    y: {
                        stacked: true, // Empilha as barras no eixo Y (para cada label)
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                },
                plugins: {
                    legend: { labels: { color: textColor } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.x !== null) { label += context.parsed.x + ' min'; }
                                return label;
                            }
                        }
                    }
                }
            }
        });
      }
    },

    // --- Módulo de Calendário (Histórico) ---
    Calendar: {
        currentDate: new Date(), // Data atual para navegação do calendário

        /** Renderiza o calendário para o mês e ano atuais. */
        renderCalendar() {
            const isMobile = window.matchMedia("(max-width: 768px)").matches;
            const calendarGrid = isMobile ? document.getElementById('calendarGridModal') : document.getElementById('calendarGrid');
            const currentMonthYearDisplay = isMobile ? document.getElementById('currentMonthYearModal') : document.getElementById('currentMonthYear');

            if (!calendarGrid || !currentMonthYearDisplay) return; // Garante que os elementos existam

            calendarGrid.innerHTML = '';

            const year = App.Calendar.currentDate.getFullYear();
            const month = App.Calendar.currentDate.getMonth(); // 0-11

            currentMonthYearDisplay.textContent = App.Calendar.currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const numDaysInMonth = lastDayOfMonth.getDate();

            // Adicionar nomes dos dias da semana
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            dayNames.forEach(dayName => {
                const div = document.createElement('div');
                div.className = 'calendar-day-name';
                div.textContent = dayName;
                calendarGrid.appendChild(div);
            });

            // Preencher dias vazios antes do primeiro dia do mês
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 = Domingo, 1 = Segunda...
            for (let i = 0; i < firstDayOfWeek; i++) {
                const div = document.createElement('div');
                div.className = 'calendar-day empty';
                calendarGrid.appendChild(div);
            }

            // Preencher os dias do mês
            for (let day = 1; day <= numDaysInMonth; day++) {
                const currentDay = new Date(year, month, day);
                const formattedDate = App.Utils.formatDateToYYYYMMDD(currentDay);
                const dayOfWeekName = App.Utils.getDayName(currentDay.getDay()); // Ex: "Segunda-feira"

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.innerHTML = `<span class="day-number">${day}</span>`;

                // Marcar o dia atual
                const today = new Date();
                if (currentDay.toDateString() === today.toDateString()) {
                    dayDiv.classList.add('today');
                }

                // Obter matérias do cronograma para este dia da semana
                const scheduledMaterias = App.data.cronogramaSemanal[dayOfWeekName]
                    ? [...new Set(App.data.cronogramaSemanal[dayOfWeekName].map(slot => slot.materia))] // Remove duplicatas
                    : [];

                // Obter matérias estudadas neste dia
                const studiedMaterias = App.data.dailyStudyLog[formattedDate] || {};

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'calendar-day-details';
                let detailsHtml = `<h4>${day} ${App.Calendar.currentDate.toLocaleString('pt-BR', { month: 'short' })}</h4>`;

                if (scheduledMaterias.length === 0) {
                    detailsHtml += '<p>Nenhuma disciplina agendada.</p>';
                } else {
                    scheduledMaterias.forEach(materia => {
                        const wasStudied = studiedMaterias[materia];
                        const statusClass = wasStudied ? 'studied' : 'not-studied';
                        const statusIcon = wasStudied ? '<i class="fas fa-check-circle status-icon"></i>' : '<i class="fas fa-times-circle status-icon"></i>';
                        detailsHtml += `<p><span class="discipline-status ${statusClass}"></span> ${materia}</p>`;
                    });
                }
                dayDiv.appendChild(detailsDiv);


                // Adicionar bolinhas de status para cada matéria agendada
                const statusContainer = document.createElement('div');
                statusContainer.style.display = 'flex';
                statusContainer.style.flexWrap = 'wrap';
                statusContainer.style.justifyContent = 'center';
                statusContainer.style.marginTop = '5px';

                scheduledMaterias.forEach(materia => {
                    const wasStudied = studiedMaterias[materia];
                    const statusClass = wasStudied ? 'studied' : 'not-studied';
                    const statusDot = document.createElement('span');
                    statusDot.className = `discipline-status ${statusClass}`;
                    statusContainer.appendChild(statusDot);
                });
                dayDiv.appendChild(statusContainer);


                calendarGrid.appendChild(dayDiv);
            }
        },

        /** Altera o mês do calendário. */
        changeMonth(delta) {
            App.Calendar.currentDate.setMonth(App.Calendar.currentDate.getMonth() + delta);
            App.Calendar.renderCalendar();
        }
    },

    // --- Módulo de Tema ---
    Theme: {
      /** Alterna entre o tema claro e escuro. */
      toggleTheme() {
        App.data.theme = App.data.theme === 'dark' ? 'light' : 'dark';
        App.Theme.applyTheme(App.data.theme);
        App.DataManager.saveData();
        App.Charts.updateCharts(); // Atualiza gráficos para refletir as novas cores
        App.Calendar.renderCalendar(); // Atualiza o calendário para refletir as novas cores
      },

      /** Aplica o tema especificado ao body. */
      applyTheme(themeName) {
        document.body.classList.remove('dark-theme', 'light-theme');
        document.body.classList.add(`${themeName}-theme`);
      }
    },

    // --- Módulo de UI (Interface do Usuário) ---
    UI: {
      /** Exibe uma mensagem de feedback temporária. */
      showFeedback(message, type, targetDivId = 'materiaFeedback') {
        const feedbackDiv = document.getElementById(targetDivId);
        if (!feedbackDiv) return;

        feedbackDiv.textContent = message;
        feedbackDiv.className = `feedback-message ${type}`;
        feedbackDiv.style.opacity = '1';

        setTimeout(() => {
          feedbackDiv.style.opacity = '0';
          setTimeout(() => {
            feedbackDiv.textContent = '';
            feedbackDiv.className = 'feedback-message';
          }, 500);
        }, 3000);
      },

      /** Abre o modal de configurações e mostra a seção inicial. */
      openSettingsModal(initialSection = 'settingsSection') {
        document.getElementById('settingsModal').classList.add('active');
        App.UI.renderMateriasModalList();
        App.Calendar.renderCalendar(); // Renderiza o calendário no modal

        // Mostra a seção inicial dentro do modal
        App.UI.showModalSection(initialSection, document.getElementById(`modalTabBtn${initialSection === 'settingsSection' ? 'Settings' : 'History'}`));
      },

      /** Fecha o modal de configurações. */
      closeSettingsModal() {
        document.getElementById('settingsModal').classList.remove('active');
      },

      /** Abre o modal de "Mais Opções". */
      openMoreOptionsModal() {
        document.getElementById('moreOptionsModal').classList.add('active');
      },

      /** Fecha o modal de "Mais Opções". */
      closeMoreOptionsModal() {
        document.getElementById('moreOptionsModal').classList.remove('active');
      },

      /** Mostra uma seção específica dentro do modal de configurações. */
      showModalSection(sectionId, clickedButton) {
        document.querySelectorAll('#settingsModal .modal-section').forEach(section => {
          section.style.display = 'none';
          section.classList.remove('active');
        });
        document.querySelectorAll('#settingsModal .tab-navigation button').forEach(button => {
          button.classList.remove('active');
        });

        document.getElementById(sectionId).style.display = 'block';
        document.getElementById(sectionId).classList.add('active');
        if (clickedButton) {
          clickedButton.classList.add('active');
        }
        // Se a seção de histórico for ativada, renderiza o calendário
        if (sectionId === 'historySectionModal') {
            App.Calendar.renderCalendar();
        }
      },

      /** Renderiza a lista de matérias base dentro do modal de configurações. */
      renderMateriasModalList() {
        const modalMateriasListDiv = document.getElementById('modalMateriasList');
        modalMateriasListDiv.innerHTML = '';

        if (App.data.materiasBase.length === 0) {
            modalMateriasListDiv.innerHTML = '<p class="no-slots-message">Nenhuma matéria base adicionada.</p>';
            return;
        }

        App.data.materiasBase.forEach(materia => {
          const materiaItem = document.createElement('div');
          materiaItem.className = 'modal-materia-item';
          materiaItem.innerHTML = `
            <span>${materia.nome}</span>
            <button class="remove-btn" onclick="App.MateriaManager.removeMateriaBase('${materia.nome}')">Remover</button>
          `;
          modalMateriasListDiv.appendChild(materiaItem);
        });
      },

      /** Renderiza a tabela de total de horas por conteúdo (para desktop) e a lista de cartões de horas (para mobile). */
      renderHorasTable() {
        const materiasAtivas = App.MateriaManager.getMateriasAtivas();
        const tbody = document.querySelector('#horasTable tbody');
        const horasCardList = document.getElementById('horasCardList');

        tbody.innerHTML = '';
        horasCardList.innerHTML = '';

        if (materiasAtivas.length === 0) {
          const noDataMessage = '<p class="no-slots-message">Nenhuma matéria com dados ou no cronograma.</p>';
          const row = tbody.insertRow();
          const cell = row.insertCell();
          cell.colSpan = 4;
          cell.innerHTML = noDataMessage;
          horasCardList.innerHTML = noDataMessage;
          return;
        }

        materiasAtivas.forEach((materia) => {
          // Renderiza para a tabela (desktop)
          const row = tbody.insertRow();
          row.insertCell().textContent = materia.nome;
          const horasCell = row.insertCell();
          horasCell.textContent = `${materia.totalHoras} min`;

          const cronometroCell = row.insertCell();
          const cronometroDisplay = document.createElement('span');
          cronometroDisplay.textContent = '00:00:00';
          cronometroDisplay.id = `cronometro-${materia.nome.replace(/\s/g, '-')}`;
          cronometroDisplay.className = 'cronometro-display';
          cronometroCell.appendChild(cronometroDisplay);

          const actionsCell = row.insertCell();
          actionsCell.className = 'cronometro-actions';
          actionsCell.id = `actions-table-${materia.nome.replace(/\s/g, '-')}`;

          const startBtn = document.createElement('button');
          startBtn.innerHTML = '<i class="fas fa-play"></i> Iniciar';
          startBtn.className = 'start-btn';
          startBtn.onclick = () => App.StudyTimer.iniciarEstudo(materia.nome, cronometroDisplay);
          actionsCell.appendChild(startBtn);

          const pauseBtn = document.createElement('button');
          pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pausar';
          pauseBtn.className = 'pause-btn';
          pauseBtn.style.display = 'none';
          pauseBtn.onclick = () => App.StudyTimer.pausarEstudo(materia.nome);
          actionsCell.appendChild(pauseBtn);

          const resumeBtn = document.createElement('button');
          resumeBtn.innerHTML = '<i class="fas fa-play"></i> Continuar';
          resumeBtn.className = 'resume-btn';
          resumeBtn.style.display = 'none';
          resumeBtn.onclick = () => App.StudyTimer.continuarEstudo(materia.nome);
          actionsCell.appendChild(resumeBtn);

          const finishBtn = document.createElement('button');
          finishBtn.innerHTML = '<i class="fas fa-stop"></i> Concluir';
          finishBtn.className = 'finish-btn';
          finishBtn.style.display = 'none';
          finishBtn.onclick = () => App.StudyTimer.concluirEstudo(materia.nome);
          actionsCell.appendChild(finishBtn);

          const resetBtn = document.createElement('button');
          resetBtn.innerHTML = '<i class="fas fa-redo"></i> Zerar';
          resetBtn.className = 'reset-btn';
          resetBtn.onclick = () => App.StudyTimer.resetarEstudo(materia.nome);
          actionsCell.appendChild(resetBtn);

          // Renderiza para o cartão (mobile)
          const card = document.createElement('div');
          card.className = 'materia-card';
          card.innerHTML = `
            <div class="card-header">${materia.nome}</div>
            <div class="card-body">
              <p>Total de Horas: <span id="card-horas-${materia.nome.replace(/\s/g, '-')}" class="total-horas">${materia.totalHoras} min</span></p>
              <div class="cronometro-section">
                <span id="card-cronometro-${materia.nome.replace(/\s/g, '-')}" class="cronometro-display">00:00:00</span>
                <div class="cronometro-actions" id="actions-card-${materia.nome.replace(/\s/g, '-')}">
                  <button class="start-btn" onclick="App.StudyTimer.iniciarEstudo('${materia.nome}', document.getElementById('card-cronometro-${materia.nome.replace(/\s/g, '-')}'))"><i class="fas fa-play"></i> Iniciar</button>
                  <button class="pause-btn" style="display:none;" onclick="App.StudyTimer.pausarEstudo('${materia.nome}')"><i class="fas fa-pause"></i> Pausar</button>
                  <button class="resume-btn" style="display:none;" onclick="App.StudyTimer.continuarEstudo('${materia.nome}')"><i class="fas fa-play"></i> Continuar</button>
                  <button class="finish-btn" style="display:none;" onclick="App.StudyTimer.concluirEstudo('${materia.nome}')"><i class="fas fa-stop"></i> Concluir</button>
                  <button class="reset-btn" onclick="App.StudyTimer.resetarEstudo('${materia.nome}')"><i class="fas fa-redo"></i> Zerar</button>
                </div>
              </div>
            </div>
          `;
          horasCardList.appendChild(card);

          // Atualiza o estado do cronômetro para ambos os displays
          if (App.activeStudyTimer.materiaNome === materia.nome) {
              const currentElapsedTime = App.activeStudyTimer.pausedTime + (Date.now() - App.activeStudyTimer.startTime);
              const formattedTime = App.StudyTimer.formatTime(currentElapsedTime);

              cronometroDisplay.textContent = formattedTime;
              cronometroDisplay.classList.add(App.activeStudyTimer.isPaused ? 'paused' : 'active');
              actionsCell.querySelector('.start-btn').style.display = 'none';
              if (App.activeStudyTimer.isPaused) {
                  actionsCell.querySelector('.pause-btn').style.display = 'none';
                  actionsCell.querySelector('.resume-btn').style.display = 'inline-block';
              } else {
                  actionsCell.querySelector('.pause-btn').style.display = 'inline-block';
                  actionsCell.querySelector('.resume-btn').style.display = 'none';
              }
              actionsCell.querySelector('.finish-btn').style.display = 'inline-block';

              const cardCronometroDisplay = document.getElementById(`card-cronometro-${materia.nome.replace(/\s/g, '-')}`);
              const cardActionsContainer = document.getElementById(`actions-card-${materia.nome.replace(/\s/g, '-')}`);
              cardCronometroDisplay.textContent = formattedTime;
              cardCronometroDisplay.classList.add(App.activeStudyTimer.isPaused ? 'paused' : 'active');
              cardActionsContainer.querySelector('.start-btn').style.display = 'none';
              if (App.activeStudyTimer.isPaused) {
                  cardActionsContainer.querySelector('.pause-btn').style.display = 'none';
                  cardActionsContainer.querySelector('.resume-btn').style.display = 'inline-block';
              } else {
                  cardActionsContainer.querySelector('.pause-btn').style.display = 'inline-block';
                  cardActionsContainer.querySelector('.resume-btn').style.display = 'none';
              }
              cardActionsContainer.querySelector('.finish-btn').style.display = 'inline-block';
          } else {
              cronometroDisplay.classList.remove('active', 'paused');
              actionsCell.querySelector('.start-btn').style.display = 'inline-block';
              actionsCell.querySelector('.pause-btn').style.display = 'none';
              actionsCell.querySelector('.resume-btn').style.display = 'none';
              actionsCell.querySelector('.finish-btn').style.display = 'none';

              const cardCronometroDisplay = document.getElementById(`card-cronometro-${materia.nome.replace(/\s/g, '-')}`);
              const cardActionsContainer = document.getElementById(`actions-card-${materia.nome.replace(/\s/g, '-')}`);
              cardCronometroDisplay.classList.remove('active', 'paused');
              cardActionsContainer.querySelector('.start-btn').style.display = 'inline-block';
              cardActionsContainer.querySelector('.pause-btn').style.display = 'none';
              cardActionsContainer.querySelector('.resume-btn').style.display = 'none';
              cardActionsContainer.querySelector('.finish-btn').style.display = 'none';
          }
        });
      },

      /** Renderiza a tabela de acertos e erros (para desktop) e a lista de cartões de questões (para mobile). */
      renderQuestoesTable() {
        const materiasAtivas = App.MateriaManager.getMateriasAtivas();
        const tbody = document.querySelector('#questoesTable tbody');
        const questoesCardList = document.getElementById('questoesCardList');

        tbody.innerHTML = '';
        questoesCardList.innerHTML = '';

        if (materiasAtivas.length === 0) {
          const noDataMessage = '<p class="no-slots-message">Nenhuma matéria com dados ou no cronograma.</p>';
          const row = tbody.insertCell();
          const cell = row.insertCell();
          cell.colSpan = 4;
          cell.innerHTML = noDataMessage;
          questoesCardList.innerHTML = noDataMessage;
          return;
        }

        materiasAtivas.forEach((materia) => {
          const totalQuestoes = materia.acertos + materia.erros;
          const percentual = totalQuestoes > 0 ? ((materia.acertos / totalQuestoes) * 100).toFixed(2) : '0.00';
          let percentualClass = '';
          if (percentual >= 80) { percentualClass = 'high'; }
          else if (percentual >= 50) { percentualClass = 'medium'; }
          else { percentualClass = 'low'; }

          // Renderiza para a tabela (desktop)
          const row = tbody.insertRow();
          row.insertCell().textContent = materia.nome;

          const acertosCell = row.insertCell();
          const acertosContainer = document.createElement('div');
          acertosContainer.className = 'input-with-buttons';
          const acertosInput = document.createElement('input');
          acertosInput.type = 'number';
          acertosInput.min = '0';
          acertosInput.value = materia.acertos;
          acertosInput.addEventListener('change', (e) => App.Questoes.updateAcertos(materia.nome, 0, e.target.value));
          const acertosBtnMinus = document.createElement('button');
          acertosBtnMinus.textContent = '-';
          acertosBtnMinus.onclick = () => { acertosInput.value = Math.max(0, Number(acertosInput.value) - 1); acertosInput.dispatchEvent(new Event('change')); };
          const acertosBtnPlus = document.createElement('button');
          acertosBtnPlus.textContent = '+';
          acertosBtnPlus.onclick = () => { acertosInput.value = Number(acertosInput.value) + 1; acertosInput.dispatchEvent(new Event('change')); };
          acertosContainer.appendChild(acertosBtnMinus);
          acertosContainer.appendChild(acertosInput);
          acertosContainer.appendChild(acertosBtnPlus);
          acertosCell.appendChild(acertosContainer);

          const errosCell = row.insertCell();
          const errosContainer = document.createElement('div');
          errosContainer.className = 'input-with-buttons';
          const errosInput = document.createElement('input');
          errosInput.type = 'number';
          errosInput.min = '0';
          errosInput.value = materia.erros;
          errosInput.addEventListener('change', (e) => App.Questoes.updateErros(materia.nome, 0, e.target.value));
          const errosBtnMinus = document.createElement('button');
          errosBtnMinus.textContent = '-';
          errosBtnMinus.onclick = () => { errosInput.value = Math.max(0, Number(errosInput.value) - 1); errosInput.dispatchEvent(new Event('change')); };
          const errosBtnPlus = document.createElement('button');
          errosBtnPlus.textContent = '+';
          errosBtnPlus.onclick = () => { errosInput.value = Number(errosInput.value) + 1; errosInput.dispatchEvent(new Event('change')); };
          errosContainer.appendChild(errosBtnMinus);
          errosContainer.appendChild(errosInput);
          errosContainer.appendChild(errosBtnPlus);
          errosCell.appendChild(errosContainer);

          const percentualCell = row.insertCell();
          percentualCell.textContent = `${percentual}%`;
          percentualCell.classList.add('percentual-acertos', percentualClass);

          // Renderiza para o cartão (mobile)
          const card = document.createElement('div');
          card.className = 'materia-card';
          card.innerHTML = `
            <div class="card-header">${materia.nome}</div>
            <div class="card-body">
              <div class="stats-row">
                <span>Acertos:</span>
                <div class="input-with-buttons">
                  <button onclick="App.Questoes.updateAcertos('${materia.nome}', -1)">-</button>
                  <input type="number" min="0" value="${materia.acertos}" onchange="App.Questoes.updateAcertos('${materia.nome}', 0, this.value)">
                  <button onclick="App.Questoes.updateAcertos('${materia.nome}', 1)">+</button>
                </div>
              </div>
              <div class="stats-row">
                <span>Erros:</span>
                <div class="input-with-buttons">
                  <button onclick="App.Questoes.updateErros('${materia.nome}', -1)">-</button>
                  <input type="number" min="0" value="${materia.erros}" onchange="App.Questoes.updateErros('${materia.nome}', 0, this.value)">
                  <button onclick="App.Questoes.updateErros('${materia.nome}', 1)">+</button>
                </div>
              </div>
              <p>Percentual: <span class="percentual-acertos ${percentualClass}">${percentual}%</span></p>
            </div>
          `;
          questoesCardList.appendChild(card);
        });
      },

      /** Renderiza todas as tabelas e cartões. */
      renderAll() {
        App.Cronograma.renderCronograma();
        App.UI.renderHorasTable();
        App.UI.renderQuestoesTable();
        App.Goals.renderGoals();
        App.UI.renderMateriasModalList(); // Garante que a lista de matérias no modal esteja atualizada
        App.Pomodoro.renderMateriaSelect(); // Garante que o select de matéria do Pomodoro esteja atualizado
        App.Calendar.renderCalendar(); // Renderiza o calendário principal
      },

      /** Função para controle das abas. */
      showTab(tabId, clickedButton) {
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
          tab.style.display = 'none';
        });

        // Desativa todos os botões de navegação (tanto desktop quanto mobile)
        document.querySelectorAll('.tab-navigation button').forEach(button => {
          button.classList.remove('active');
        });
        document.querySelectorAll('.desktop-nav .nav-btn').forEach(button => {
          button.classList.remove('active');
        });

        const activeTabContent = document.getElementById(tabId);
        activeTabContent.classList.add('active');
        activeTabContent.style.display = 'block';

        // Ativa o botão clicado
        if (clickedButton) {
          clickedButton.classList.add('active');
        }

        // Se o botão clicado for de uma aba "oculta" no mobile,
        // garante que o botão "Mais" também esteja ativo.
        const isMobile = window.matchMedia("(max-width: 768px)").matches;
        if (isMobile && ['metasTab', 'pomodoroTab', 'historicoTab'].includes(tabId)) {
            document.getElementById('tabBtnMore').classList.add('active');
        }


        if (tabId === 'graficosTab') {
          App.Charts.updateCharts();
        }
        if (tabId === 'pomodoroTab') {
            App.Pomodoro.initPomodoroDisplay(); // Garante que o display do pomodoro esteja correto
        }
        if (tabId === 'metasTab') {
            App.Goals.renderGoals(); // Garante que as metas sejam renderizadas
        }
        if (tabId === 'historicoTab') { // Para a aba de histórico no desktop
            App.Calendar.renderCalendar();
        }

        // Garante que as tabelas/cartões corretos sejam exibidos/escondidos
        App.UI.renderAll();
      }
    },

    // --- Inicialização da Aplicação ---
    init() {
      App.DataManager.loadData();
      App.Theme.applyTheme(App.data.theme);
      App.UI.renderAll();
      App.Charts.updateCharts();
      App.Pomodoro.initPomodoroDisplay(); // Inicializa o display do Pomodoro
      App.Goals.scheduleWeeklyReset(); // Adicionar esta linha para agendar o reset
      App.Calendar.renderCalendar(); // Renderiza o calendário inicial

      // Ajusta o padding superior do body para o header fixo em desktop
      const headerHeight = document.querySelector('.main-header').offsetHeight;
      if (window.matchMedia("(min-width: 769px)").matches) {
          document.body.style.paddingTop = `${headerHeight + 20}px`;
      } else {
          document.body.style.paddingTop = `20px`;
      }

      // Lógica para ativar a primeira aba e seu botão correspondente
      // Prioriza o cronograma como aba inicial
      if (window.matchMedia("(max-width: 768px)").matches) {
        const tabBtnCronograma = document.getElementById('tabBtnCronograma');
        if (tabBtnCronograma) {
          App.UI.showTab('cronogramaTab', tabBtnCronograma);
        }
      } else {
        const desktopTabBtnCronograma = document.getElementById('desktopTabBtnCronograma');
        if (desktopTabBtnCronograma) {
          App.UI.showTab('cronogramaTab', desktopTabBtnCronograma);
        }
      }

      // --- Lógica PWA ---
      window.addEventListener('beforeinstallprompt', (e) => {
        // Previne que o mini-infobar apareça automaticamente
        e.preventDefault();
        // Armazena o evento para que possa ser disparado mais tarde.
        App.deferredInstallPrompt = e;
        // Mostra o botão de instalação
        const installButton = document.getElementById('installAppButton');
        if (installButton) {
          installButton.style.display = 'inline-block';
          installButton.onclick = () => {
            if (App.deferredInstallPrompt) {
              App.deferredInstallPrompt.prompt();
              App.deferredInstallPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                  App.UI.showFeedback('Aplicativo instalado com sucesso!', 'success', 'dataFeedback');
                  console.log('Usuário aceitou o prompt de instalação do A2HS');
                } else {
                  App.UI.showFeedback('Instalação do aplicativo cancelada.', 'error', 'dataFeedback');
                  console.log('Usuário recusou o prompt de instalação do A2HS');
                }
                App.deferredInstallPrompt = null;
                installButton.style.display = 'none'; // Esconde o botão após a tentativa
              });
            }
          };
        }
      });

      window.addEventListener('appinstalled', () => {
        // O aplicativo foi instalado
        App.UI.showFeedback('Plano de Estudo agora está na sua tela inicial!', 'success', 'dataFeedback');
        const installButton = document.getElementById('installAppButton');
        if (installButton) {
          installButton.style.display = 'none'; // Esconde o botão se já estiver instalado
        }
        console.log('PWA foi instalado');
      });

      // Verifica se já está rodando como PWA (standalone)
      if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
        const installButton = document.getElementById('installAppButton');
        if (installButton) {
          installButton.style.display = 'none'; // Esconde o botão se já estiver no modo standalone
        }
      }

      // Registro do Service Worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('service-worker.js')
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    }
  };

  // Inicializa a aplicação quando o DOM estiver completamente carregado
  document.addEventListener('DOMContentLoaded', () => {
    App.init();
  });
</script>
</body>
</html>
