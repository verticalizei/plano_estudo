<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Planilha de Estudos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Estilos Gerais - Tema Escuro */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #1a1a2e; /* Fundo escuro */
      color: #e0e0e0; /* Texto claro */
      line-height: 1.6;
    }

    h1, h2 {
      color: #e94560; /* Título em destaque */
      margin-top: 30px;
      border-bottom: 2px solid #0f3460;
      padding-bottom: 10px;
    }

    /* Estilos de Tabela */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      background-color: #0f3460; /* Fundo da tabela */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      overflow: hidden; /* Para bordas arredondadas */
    }

    th, td {
      border: 1px solid #1a1a2e; /* Bordas da célula */
      padding: 12px;
      text-align: center;
      color: #e0e0e0;
    }

    th {
      background-color: #0a1931; /* Cabeçalho da tabela */
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:nth-child(even) {
      background-color: #16213e; /* Linhas pares */
    }

    /* Estilos de Input e Select */
    input[type="number"],
    input[type="text"],
    select {
      width: 80px; /* Ajustado para melhor visualização */
      padding: 8px;
      text-align: center;
      border: 1px solid #4a4a6a;
      border-radius: 4px;
      background-color: #2e2e4a; /* Fundo do input/select */
      color: #e0e0e0; /* Texto do input/select */
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      -webkit-appearance: none; /* Remove estilo padrão do select no WebKit */
      -moz-appearance: none; /* Remove estilo padrão do select no Mozilla */
      appearance: none; /* Remove estilo padrão do select */
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.4H18.6c-5%200-9.3%201.8-13.2%206.4-3.9%204.5-6%2010-6%2016.3%200%206.2%202.1%2011.7%206%2016.3l118.4%20118.4c3.9%203.9%209.4%206%2016.3%206s12.4-2.1%2016.3-6L287%20102c3.9-4.5%206-10%206-16.3s-2.1-11.7-6-16.3z%22%2F%3E%3C%2Fsvg%3E'); /* Seta customizada para select */
      background-repeat: no-repeat;
      background-position: right 8px top 50%;
      background-size: 12px auto;
      padding-right: 25px; /* Espaço para a seta */
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus {
      border-color: #e94560;
      box-shadow: 0 0 0 2px rgba(233, 69, 96, 0.3);
      outline: none;
    }

    /* Estilos de Botão */
    button {
      background-color: #e94560; /* Cor do botão */
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      white-space: nowrap; /* Evita quebra de linha em botões pequenos */
    }

    button:hover {
      background-color: #c23a50;
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    button.remove-btn {
      background-color: #ef5350; /* Vermelho para remover */
    }
    button.remove-btn:hover {
      background-color: #d32f2f;
    }

    button.start-btn {
      background-color: #66bb6a; /* Verde para iniciar */
      padding: 8px 12px; /* Ajuste para botões de cronômetro */
      font-size: 12px;
    }
    button.start-btn:hover {
      background-color: #4caf50;
    }

    button.pause-btn {
      background-color: #ffb300; /* Amarelo para pausar */
      padding: 8px 12px;
      font-size: 12px;
    }
    button.pause-btn:hover {
      background-color: #ffa000;
    }

    button.resume-btn {
      background-color: #2196f3; /* Azul para continuar */
      padding: 8px 12px;
      font-size: 12px;
    }
    button.resume-btn:hover {
      background-color: #1976d2;
    }

    button.finish-btn {
      background-color: #e94560; /* Vermelho/Destaque para concluir */
      padding: 8px 12px;
      font-size: 12px;
    }
    button.finish-btn:hover {
      background-color: #c23a50;
    }

    /* Contêiner de Gráficos */
    .container {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 40px;
    }

    .chart-container {
      width: 100%;
      max-width: 500px; /* Limita a largura para melhor visualização */
      background-color: #0f3460;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .chart-container h2 {
      color: #e0e0e0;
      border-bottom: 1px solid #1a1a2e;
      margin-top: 0;
      padding-bottom: 10px;
      text-align: center;
    }

    /* Estilos para o gerenciamento de matérias */
    .materia-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
      flex-wrap: wrap; /* Permite quebra de linha em telas pequenas */
    }

    .materia-actions input[type="text"] {
      flex-grow: 1;
      width: auto; /* Permite que o input cresça */
    }

    .materia-actions button {
      margin-top: 0;
      padding: 10px 15px;
      font-size: 14px;
    }

    /* Feedback message */
    .feedback-message {
        margin-top: 10px;
        padding: 8px;
        border-radius: 4px;
        font-size: 0.9em;
        text-align: center;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }

    .feedback-message.success {
        background-color: #4CAF50;
        color: white;
    }

    .feedback-message.error {
        background-color: #f44336;
        color: white;
    }

    /* Cronograma Semanal - Layout por dia */
    .cronograma-dia {
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding: 5px;
      background-color: #16213e;
      border-radius: 5px;
      min-width: 150px; /* Garante largura mínima para o bloco do dia */
    }

    .cronograma-slot {
      display: flex;
      gap: 5px;
      align-items: center;
      justify-content: center;
    }

    .cronograma-slot select {
      flex-grow: 1;
      width: auto;
    }

    .cronograma-slot input[type="number"] {
      width: 60px;
    }

    .no-slots-message {
        color: #999;
        font-style: italic;
        padding: 10px;
        text-align: center;
    }

    /* Novo estilo para o botão "Adicionar Slot" (ícone +) */
    .add-slot-btn {
      background-color: #66bb6a; /* Verde para adicionar */
      color: white;
      border-radius: 50%; /* Botão redondo */
      width: 30px; /* Largura e altura iguais para ser redondo */
      height: 30px;
      padding: 0; /* Remove padding padrão */
      font-size: 20px; /* Tamanho do + */
      line-height: 1; /* Alinha o + verticalmente */
      display: flex; /* Para centralizar o + */
      justify-content: center;
      align-items: center;
      margin: 5px auto 0; /* Centraliza horizontalmente e adiciona margem superior */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .add-slot-btn:hover {
      background-color: #4caf50;
      transform: translateY(-1px) scale(1.05); /* Pequeno efeito de zoom */
    }
    .add-slot-btn:active {
      transform: translateY(0) scale(1);
    }


    /* Estilo para o display do cronômetro */
    .cronometro-display {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 1.1em;
      color: #66bb6a; /* Cor verde para o tempo */
      min-width: 80px; /* Garante largura mínima para o display */
      display: inline-block;
    }

    .cronometro-display.active {
        color: #e94560; /* Cor de destaque quando ativo */
        font-weight: bold;
    }

    .cronometro-display.paused {
        color: #ffb300; /* Cor de destaque quando pausado */
        font-weight: bold;
    }

    /* Estilo para o contêiner de botões do cronômetro */
    .cronometro-actions {
      display: flex;
      flex-wrap: wrap; /* Permite que os botões quebrem linha */
      gap: 5px; /* Espaçamento entre os botões */
      justify-content: center; /* Centraliza os botões */
    }

    /* Estilos para os botões de incremento/decremento */
    .input-with-buttons {
        display: flex;
        align-items: center;
        gap: 2px;
    }
    .input-with-buttons input[type="number"] {
        width: 50px; /* Ajusta largura do input */
        flex-grow: 0;
    }
    .input-with-buttons button {
        width: 25px;
        height: 25px;
        padding: 0;
        font-size: 16px;
        line-height: 1;
        margin: 0;
        border-radius: 3px;
        background-color: #0f3460;
    }
    .input-with-buttons button:hover {
        background-color: #16213e;
    }

    /* Cores para o percentual de acertos */
    .percentual-acertos.high { color: #66bb6a; } /* Verde */
    .percentual-acertos.medium { color: #ffb300; } /* Amarelo */
    .percentual-acertos.low { color: #ef5350; } /* Vermelho */

    /* Estilos do Modal (Popup) */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: #0f3460;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
      width: 90%;
      max-width: 500px;
      transform: translateY(-20px);
      transition: transform 0.3s ease;
      position: relative; /* Para o botão de fechar */
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-content h3 {
      color: #e94560;
      margin-top: 0;
      margin-bottom: 20px;
      border-bottom: 1px solid #1a1a2e;
      padding-bottom: 10px;
      text-align: center;
    }

    .modal-close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #e0e0e0;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      margin: 0; /* Remove margin-top padrão do botão */
      transition: color 0.2s ease;
    }

    .modal-close-btn:hover {
      color: #e94560;
    }

    .modal-materia-list {
        max-height: 300px; /* Limita a altura para scroll */
        overflow-y: auto;
        padding-right: 10px; /* Espaço para a barra de rolagem */
    }

    .modal-materia-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #1a1a2e;
    }

    .modal-materia-item:last-child {
        border-bottom: none;
    }

    .modal-materia-item span {
        flex-grow: 1;
        text-align: left;
        padding-left: 5px;
    }

    .modal-materia-item button {
        margin-top: 0;
        padding: 5px 10px;
        font-size: 12px;
    }

    /* Novos estilos para a navegação em abas (escondida por padrão) */
    .tab-navigation {
      display: none; /* Esconder por padrão, mostrar apenas em mobile */
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #0a1931; /* Cor do cabeçalho da tabela */
      border-top: 1px solid #0f3460;
      justify-content: space-around; /* Usado quando display: flex */
      padding: 10px 0;
      z-index: 999;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
    }

    .tab-navigation button {
      background: none;
      border: none;
      color: #e0e0e0;
      font-size: 12px;
      padding: 8px 5px;
      flex: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      transition: color 0.3s ease;
      margin-top: 0; /* Sobrescrever margin-top padrão do botão */
      box-shadow: none; /* Remover sombra padrão do botão */
    }

    .tab-navigation button:hover,
    .tab-navigation button.active {
      color: #e94560;
    }

    .tab-navigation button.active {
      font-weight: bold;
    }

    .tab-navigation button i { /* Ícones para as abas */
      font-size: 18px;
    }

    /* Conteúdo das abas (visível por padrão para desktop) */
    .tab-content {
      display: block;
    }

    /* Estilos para "cartões" de seção (aplicados sempre, mas mais relevantes em mobile) */
    .section-card {
      background-color: #0f3460;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px; /* Espaçamento entre os cartões */
    }

    /* Estilos para a nova seção de Salvar/Carregar */
    .data-management-section {
      margin-top: 40px;
      padding: 20px;
      background-color: #0f3460;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .data-management-section h2 {
      color: #e94560;
      border-bottom: 1px solid #1a1a2e;
      margin-top: 0;
      padding-bottom: 10px;
    }

    .data-management-section .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .data-management-section button {
      margin-top: 0; /* Sobrescrever margin-top padrão do botão */
      padding: 10px 20px;
      font-size: 14px;
    }

    .data-management-section input[type="file"] {
      display: none; /* Esconder o input de arquivo padrão */
    }

    /* Responsividade */
    @media (max-width: 768px) {
      body {
        padding: 10px 10px 70px 10px; /* Ajustar padding inferior para a barra de navegação */
      }
      h1 {
        text-align: center;
      }
      .container {
        flex-direction: column;
        align-items: center;
      }
      .chart-container {
        width: 95%;
      }
      table, th, td {
        font-size: 12px;
        padding: 6px;
      }
      /* Ajuste para tabelas em telas pequenas */
      #cronogramaTable {
        display: block;
        overflow-x: auto;
        white-space: nowrap; /* Impede quebra de linha no cabeçalho */
      }
      #cronogramaTable th, #cronogramaTable td {
        min-width: 120px; /* Garante largura mínima para células do cronograma */
        vertical-align: top; /* Alinha o conteúdo ao topo */
      }
      .cronograma-dia {
        min-width: 120px; /* Ajusta para telas menores */
      }
      /* Ajustes para os elementos do slot do cronograma em mobile */
      .cronograma-slot {
        flex-wrap: wrap; /* Permite que os elementos do slot quebrem linha */
        justify-content: flex-start;
        flex-direction: column; /* Empilha matéria, duração e botão de remover */
        align-items: stretch;
      }
      .cronograma-slot select,
      .cronograma-slot input[type="number"] {
        width: 100%; /* Ocupa toda a largura disponível */
        margin-bottom: 5px; /* Adiciona espaço entre os elementos empilhados */
      }
      .cronograma-slot button.remove-btn {
        width: 100%; /* Botão de remover ocupa a largura total */
        margin-top: 5px;
      }

      .cronometro-actions button { /* Ajusta botões de cronômetro em telas pequenas */
        width: 100%; /* Ocupa toda a largura disponível */
        margin-top: 0; /* Remove margem superior extra */
      }
      .materia-actions {
        flex-direction: column;
        align-items: stretch;
      }
      .materia-actions button {
        width: 100%;
      }
      .materia-actions input[type="text"] {
        width: 100%;
      }
      .modal-content {
        padding: 20px;
      }

      /* Ativar navegação em abas e esconder seções não ativas em mobile */
      .tab-navigation {
        display: flex; /* Mostrar a navegação em abas em telas pequenas */
      }

      .tab-content {
        display: none; /* Esconder todas as abas por padrão em mobile */
        padding-bottom: 0; /* Resetar padding inferior para o conteúdo da aba */
      }

      .tab-content.active {
        display: block; /* Mostrar apenas a aba ativa em mobile */
      }

      /* Esconder os títulos H2 quando as abas estiverem ativas para evitar duplicação */
      .tab-content h2 {
        display: none;
      }

      /* Ajustes para os botões de incremento/decremento em mobile */
      .input-with-buttons {
        width: 100%;
        justify-content: center; /* Centraliza os botões e input */
      }
      .input-with-buttons input[type="number"] {
        flex-grow: 1; /* Permite que o input cresça */
        max-width: 80px; /* Limita a largura para não ficar muito grande */
      }

      /* Ajustes para a seção de gerenciamento de dados em mobile */
      .data-management-section .button-group {
        flex-direction: column; /* Empilha os botões */
      }
      .data-management-section button {
        width: 100%; /* Ocupa a largura total */
      }
    }
  </style>
</head>
<body>
  <h1>Planilha de Estudos</h1>

  <!-- Gerenciamento de Matérias Base -->
  <div id="materiasTab" class="tab-content">
    <div class="section-card">
      <h2>Gerenciar Matérias Base</h2>
      <div class="materia-actions">
        <input type="text" id="novaMateriaNome" placeholder="Nome da nova matéria">
        <button onclick="adicionarMateriaBase()">Adicionar Matéria</button>
        <button onclick="openMateriasModal()">Gerenciar Matérias</button>
      </div>
      <div id="materiaFeedback" class="feedback-message"></div>
    </div>
  </div>

  <!-- Cronograma Semanal -->
  <div id="cronogramaTab" class="tab-content">
    <div class="section-card">
      <h2>Cronograma Semanal</h2>
      <table id="cronogramaTable">
        <thead>
          <tr>
            <th>Dia</th>
            <th>Slots de Estudo</th>
          </tr>
        </thead>
        <tbody>
          <!-- Conteúdo gerado por JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Totais de Horas -->
  <div id="horasTab" class="tab-content">
    <div class="section-card">
      <h2>Total de Horas por Conteúdo</h2>
      <table id="horasTable">
        <thead>
          <tr><th>Matéria</th><th>Total de Horas (min)</th><th>Cronômetro</th><th>Ações</th></tr>
        </thead>
        <tbody>
          <!-- Conteúdo gerado por JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Acertos e Erros -->
  <div id="questoesTab" class="tab-content">
    <div class="section-card">
      <h2>Questões (Acertos x Erros)</h2>
      <table id="questoesTable">
        <thead>
          <tr><th>Matéria</th><th>Acertos</th><th>Erros</th><th>% Acertos</th></tr>
        </thead>
        <tbody>
          <!-- Conteúdo gerado por JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Gráficos -->
  <div id="graficosTab" class="tab-content">
    <div class="section-card">
      <h2>Gráficos</h2>
      <div class="container">
        <div class="chart-container">
          <h2>Horas por Matéria</h2>
          <canvas id="chartHoras"></canvas>
        </div>
        <div class="chart-container">
          <h2>Acertos x Erros</h2>
          <canvas id="chartQuestoes"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Adicionado: Seção para Salvar/Carregar Progresso -->
  <div class="data-management-section section-card">
    <h2>Gerenciar Dados</h2>
    <div class="button-group">
      <button onclick="salvarProgressoJSON()">
        <i class="fas fa-download"></i> Salvar Progresso
      </button>
      <input type="file" id="uploadJsonInput" accept=".json" onchange="carregarProgressoJSON(event)">
      <button onclick="document.getElementById('uploadJsonInput').click()">
        <i class="fas fa-upload"></i> Carregar Progresso
      </button>
    </div>
    <div id="dataFeedback" class="feedback-message"></div>
  </div>

  <!-- Navegação em Abas (para mobile) -->
  <div class="tab-navigation">
    <button id="tabBtnMaterias" onclick="showTab('materiasTab', this)">
      <i class="fas fa-book"></i>
      <span>Matérias</span>
    </button>
    <button id="tabBtnCronograma" onclick="showTab('cronogramaTab', this)">
      <i class="fas fa-calendar-alt"></i>
      <span>Cronograma</span>
    </button>
    <button id="tabBtnHoras" onclick="showTab('horasTab', this)">
      <i class="fas fa-clock"></i>
      <span>Horas</span>
    </button>
    <button id="tabBtnQuestoes" onclick="showTab('questoesTab', this)">
      <i class="fas fa-question-circle"></i>
      <span>Questões</span>
    </button>
    <button id="tabBtnGraficos" onclick="showTab('graficosTab', this)">
      <i class="fas fa-chart-bar"></i>
      <span>Gráficos</span>
    </button>
  </div>

  <!-- Modal para Gerenciar Matérias (manter inalterado) -->
  <div id="materiasModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="closeMateriasModal()">&times;</button>
      <h3>Matérias Cadastradas</h3>
      <div id="modalMateriasList" class="modal-materia-list">
        <!-- Matérias base serão renderizadas aqui pelo JS no modal -->
      </div>
    </div>
  </div>

<script>
  let chartHoras, chartQuestoes;

  // Estrutura de dados principal
  let appData = {
    materiasBase: [
      { nome: 'Português', totalHoras: 0, acertos: 0, erros: 0 },
      { nome: 'Penal Processual', totalHoras: 0, acertos: 0, erros: 0 },
      { nome: 'Direito Penal', totalHoras: 0, acertos: 0, erros: 0 },
      { nome: 'Direitos Humanos', totalHoras: 0, acertos: 0, erros: 0 },
      { nome: 'Legislação', totalHoras: 0, acertos: 0, erros: 0 },
      { nome: 'Raciocínio Lógico', totalHoras: 0, acertos: 0, erros: 0 },
      { nome: 'Informática', totalHoras: 0, acertos: 0, erros: 0 },
      { nome: 'Constitucional', totalHoras: 0, acertos: 0, erros: 0 },
      { nome: 'Administrativo', totalHoras: 0, acertos: 0, erros: 0 }
    ],
    cronogramaSemanal: {
      'Segunda': [],
      'Terça': [],
      'Quarta': [],
      'Quinta': [],
      'Sexta': [],
      'Sábado': [],
      'Domingo': []
    }
  };

  const diasSemana = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];

  // Variáveis globais para o cronômetro ativo
  let activeCronometer = {
    interval: null,
    materiaNome: null,
    displayElement: null,
    startTime: 0,
    pausedTime: 0,
    isPaused: false
  };

  /**
   * Salva os dados da aplicação no localStorage.
   */
  function salvarDados() {
    localStorage.setItem('planilhaEstudoData', JSON.stringify(appData));
  }

  /**
   * Carrega os dados da aplicação do localStorage.
   */
  function carregarDados() {
    const dadosSalvos = localStorage.getItem('planilhaEstudoData');
    if (dadosSalvos) {
      const parsedData = JSON.parse(dadosSalvos);

      // Mescla os dados salvos com a estrutura padrão para garantir novas propriedades
      // e lidar com a possibilidade de dados antigos sem certas chaves
      appData.materiasBase = parsedData.materiasBase || [];
      appData.cronogramaSemanal = parsedData.cronogramaSemanal || {
        'Segunda': [], 'Terça': [], 'Quarta': [], 'Quinta': [], 'Sexta': [], 'Sábado': [], 'Domingo': []
      };

      // Garante que todas as matérias base tenham as propriedades necessárias
      appData.materiasBase.forEach(materia => {
        materia.totalHoras = materia.totalHoras || 0;
        materia.acertos = materia.acertos || 0;
        materia.erros = materia.erros || 0;
      });

      // Garante que os slots do cronograma tenham as propriedades necessárias
      Object.keys(appData.cronogramaSemanal).forEach(dia => {
        appData.cronogramaSemanal[dia] = appData.cronogramaSemanal[dia].map(slot => ({
          materia: slot.materia || '',
          duracao: slot.duracao || 0
        }));
      });
    }
  }

  /**
   * Exibe uma mensagem de feedback temporária.
   * @param {string} message - A mensagem a ser exibida.
   * @param {string} type - O tipo de mensagem ('success' ou 'error').
   * @param {string} targetDivId - O ID da div de feedback (ex: 'materiaFeedback', 'dataFeedback').
   */
  function showFeedback(message, type, targetDivId = 'materiaFeedback') {
    const feedbackDiv = document.getElementById(targetDivId);
    if (!feedbackDiv) return; // Garante que a div exista

    feedbackDiv.textContent = message;
    feedbackDiv.className = `feedback-message ${type}`;
    feedbackDiv.style.opacity = '1';

    setTimeout(() => {
      feedbackDiv.style.opacity = '0';
      setTimeout(() => {
        feedbackDiv.textContent = '';
        feedbackDiv.className = 'feedback-message';
      }, 500); // Espera a transição de opacidade terminar
    }, 3000); // Mensagem visível por 3 segundos
  }

  /**
   * Abre o modal de gerenciamento de matérias.
   */
  function openMateriasModal() {
    document.getElementById('materiasModal').classList.add('active');
    renderizarMateriasModalList(); // Renderiza a lista dentro do modal
  }

  /**
   * Fecha o modal de gerenciamento de matérias.
   */
  function closeMateriasModal() {
    document.getElementById('materiasModal').classList.remove('active');
  }

  /**
   * Renderiza a lista de matérias base dentro do modal.
   */
  function renderizarMateriasModalList() {
    const modalMateriasListDiv = document.getElementById('modalMateriasList');
    modalMateriasListDiv.innerHTML = '';

    if (appData.materiasBase.length === 0) {
        modalMateriasListDiv.innerHTML = '<p class="no-slots-message">Nenhuma matéria base adicionada.</p>';
        return;
    }

    appData.materiasBase.forEach(materia => {
      const materiaItem = document.createElement('div');
      materiaItem.className = 'modal-materia-item';
      materiaItem.innerHTML = `
        <span>${materia.nome}</span>
        <button class="remove-btn" onclick="removerMateriaBase('${materia.nome}')">Remover</button>
      `;
      modalMateriasListDiv.appendChild(materiaItem);
    });
  }

  /**
   * Renderiza a tabela do cronograma semanal.
   */
  function renderizarCronograma() {
    const tbody = document.querySelector('#cronogramaTable tbody');
    tbody.innerHTML = ''; // Limpa o corpo da tabela

    diasSemana.forEach(dia => {
      const row = tbody.insertRow();
      row.insertCell().textContent = dia; // Nome do dia

      const slotsCell = row.insertCell();
      const diaContainer = document.createElement('div');
      diaContainer.className = 'cronograma-dia';
      diaContainer.id = `cronograma-dia-${dia}`;

      // Renderiza os slots existentes para este dia
      if (appData.cronogramaSemanal[dia].length === 0) {
          const noSlotsMessage = document.createElement('p');
          noSlotsMessage.className = 'no-slots-message';
          noSlotsMessage.textContent = 'Nenhum slot adicionado para este dia.';
          diaContainer.appendChild(noSlotsMessage);
      } else {
          appData.cronogramaSemanal[dia].forEach((slot, slotIndex) => {
            diaContainer.appendChild(criarSlotCronograma(dia, slotIndex, slot.materia, slot.duracao));
          });
      }

      // Botão para adicionar novo slot (agora com ícone +)
      const addSlotBtn = document.createElement('button');
      addSlotBtn.textContent = '+'; // Texto do botão é apenas o sinal de mais
      addSlotBtn.className = 'add-slot-btn'; // Adiciona a nova classe para estilo
      addSlotBtn.onclick = () => adicionarSlotCronograma(dia);
      diaContainer.appendChild(addSlotBtn);

      slotsCell.appendChild(diaContainer);
    });
  }

  /**
   * Cria e retorna um elemento de slot de cronograma.
   * @param {string} dia - O dia da semana.
   * @param {number} slotIndex - O índice do slot no array do dia.
   * @param {string} [materiaSelecionada=''] - A matéria pré-selecionada.
   * @param {number} [duracao=0] - A duração pré-definida.
   * @returns {HTMLElement} O elemento div do slot.
   */
  function criarSlotCronograma(dia, slotIndex, materiaSelecionada = '', duracao = 0) {
    const slotDiv = document.createElement('div');
    slotDiv.className = 'cronograma-slot';
    slotDiv.dataset.dia = dia;
    slotDiv.dataset.slotIndex = slotIndex;

    // Select de matérias
    const selectMateria = document.createElement('select');
    // Garante que a lista de matérias base esteja populada antes de criar as opções
    if (appData.materiasBase.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Nenhuma matéria';
        selectMateria.appendChild(option);
        selectMateria.disabled = true; // Desabilita se não houver matérias
    } else {
        appData.materiasBase.forEach(materia => {
            const option = document.createElement('option');
            option.value = materia.nome;
            option.textContent = materia.nome;
            selectMateria.appendChild(option);
        });
        // Define a matéria selecionada, ou a primeira se a selecionada não existir
        selectMateria.value = materiaSelecionada || appData.materiasBase[0].nome;
    }

    selectMateria.addEventListener('change', (e) => {
      appData.cronogramaSemanal[dia][slotIndex].materia = e.target.value;
      salvarDados();
      renderizarTabelas(); // Re-renderiza para atualizar as tabelas de horas/questões
    });
    slotDiv.appendChild(selectMateria);

    // Input de duração
    const inputDuracao = document.createElement('input');
    inputDuracao.type = 'number';
    inputDuracao.min = '0';
    inputDuracao.placeholder = 'min';
    inputDuracao.value = duracao;
    inputDuracao.addEventListener('change', (e) => {
      appData.cronogramaSemanal[dia][slotIndex].duracao = Number(e.target.value);
      salvarDados();
    });
    slotDiv.appendChild(inputDuracao);

    // Botão de remover slot
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'X';
    removeBtn.className = 'remove-btn';
    removeBtn.style.padding = '5px 8px';
    removeBtn.style.fontSize = '10px';
    removeBtn.style.marginTop = '0';
    removeBtn.onclick = () => removerSlotCronograma(dia, slotIndex);
    slotDiv.appendChild(removeBtn);

    return slotDiv;
  }

  /**
   * Adiciona um novo slot de estudo para um dia específico.
   * @param {string} dia - O dia da semana.
   */
  function adicionarSlotCronograma(dia) {
    if (appData.materiasBase.length === 0) {
        showFeedback('Por favor, adicione pelo menos uma matéria base antes de criar um slot de estudo.', 'error');
        return;
    }
    const newSlot = { materia: appData.materiasBase[0].nome, duracao: 60 }; // Usa a primeira matéria como padrão, duração 60 min
    appData.cronogramaSemanal[dia].push(newSlot);
    salvarDados();
    renderizarCronograma(); // Re-renderiza para mostrar o novo slot
    renderizarHorasTable(); // Atualiza a tabela de horas
    renderizarQuestoesTable(); // Atualiza a tabela de questões
    atualizarGraficos(); // Atualiza os gráficos
  }

  /**
   * Remove um slot de estudo de um dia específico.
   * @param {string} dia - O dia da semana.
   * @param {number} slotIndex - O índice do slot a ser removido.
   */
  function removerSlotCronograma(dia, slotIndex) {
    appData.cronogramaSemanal[dia].splice(slotIndex, 1);
    salvarDados();
    renderizarCronograma(); // Re-renderiza para remover o slot
    renderizarHorasTable(); // Atualiza a tabela de horas
    renderizarQuestoesTable(); // Atualiza a tabela de questões
    atualizarGraficos(); // Atualiza os gráficos
  }

  /**
   * Renderiza a tabela de total de horas por conteúdo.
   * Lista apenas as matérias ativas (no cronograma ou com dados).
   */
  function renderizarHorasTable() {
    const tbody = document.querySelector('#horasTable tbody');
    tbody.innerHTML = '';

    // Filtra apenas as matérias que estão ativas (no cronograma ou com dados)
    const materiasAtivas = appData.materiasBase.filter(materia => {
      // Verifica se a matéria está em algum slot do cronograma
      const isInCronograma = Object.values(appData.cronogramaSemanal).some(slots =>
        slots.some(slot => slot.materia === materia.nome)
      );
      // Ou se tem horas ou questões registradas
      return isInCronograma || materia.totalHoras > 0 || materia.acertos > 0 || materia.erros > 0;
    });

    materiasAtivas.forEach((materia) => {
      const row = tbody.insertRow();
      row.insertCell().textContent = materia.nome;
      const horasCell = row.insertCell();
      horasCell.textContent = `${materia.totalHoras} min`;

      // Célula do cronômetro
      const cronometroCell = row.insertCell();
      const cronometroDisplay = document.createElement('span');
      cronometroDisplay.textContent = '00:00:00';
      cronometroDisplay.id = `cronometro-${materia.nome.replace(/\s/g, '-')}`; // ID único
      cronometroDisplay.className = 'cronometro-display'; // Adiciona classe para estilo
      cronometroCell.appendChild(cronometroDisplay);

      // Célula de ações (botões do cronômetro)
      const actionsCell = row.insertCell();
      actionsCell.className = 'cronometro-actions'; // Adiciona classe para flexbox em mobile

      const startBtn = document.createElement('button');
      startBtn.textContent = 'Iniciar Estudo';
      startBtn.className = 'start-btn';
      startBtn.onclick = () => iniciarEstudo(materia.nome, cronometroDisplay);
      actionsCell.appendChild(startBtn);

      const pauseBtn = document.createElement('button');
      pauseBtn.textContent = 'Pausar';
      pauseBtn.className = 'pause-btn';
      pauseBtn.style.display = 'none';
      pauseBtn.onclick = () => pausarEstudo(materia.nome);
      actionsCell.appendChild(pauseBtn);

      const resumeBtn = document.createElement('button');
      resumeBtn.textContent = 'Continuar';
      resumeBtn.className = 'resume-btn';
      resumeBtn.style.display = 'none';
      resumeBtn.onclick = () => continuarEstudo(materia.nome);
      actionsCell.appendChild(resumeBtn);

      const finishBtn = document.createElement('button');
      finishBtn.textContent = 'Concluir Estudo';
      finishBtn.className = 'finish-btn';
      finishBtn.style.display = 'none';
      finishBtn.onclick = () => concluirEstudo(materia.nome);
      actionsCell.appendChild(finishBtn);

      // Lógica para exibir os botões corretos ao renderizar a tabela
      if (activeCronometer.materiaNome === materia.nome) {
          // Se esta é a matéria com o cronômetro ativo
          cronometroDisplay.textContent = formatTime(activeCronometer.pausedTime + (Date.now() - activeCronometer.startTime));
          cronometroDisplay.classList.add(activeCronometer.isPaused ? 'paused' : 'active');
          startBtn.style.display = 'none';
          if (activeCronometer.isPaused) {
              pauseBtn.style.display = 'none';
              resumeBtn.style.display = 'inline-block';
          } else {
              pauseBtn.style.display = 'inline-block';
              resumeBtn.style.display = 'none';
          }
          finishBtn.style.display = 'inline-block';
          activeCronometer.displayElement = cronometroDisplay; // Reatribui o elemento de display
      } else {
          // Para todas as outras matérias, apenas o botão "Iniciar Estudo" deve estar visível
          cronometroDisplay.classList.remove('active', 'paused');
          startBtn.style.display = 'inline-block';
          pauseBtn.style.display = 'none';
          resumeBtn.style.display = 'none';
          finishBtn.style.display = 'none';
      }
    });
  }

  /**
   * Formata o tempo em milissegundos para HH:MM:SS.
   * @param {number} ms - Tempo em milissegundos.
   * @returns {string} Tempo formatado.
   */
  function formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }

  /**
   * Inicia o cronômetro para uma matéria.
   * @param {string} materiaNome - O nome da matéria.
   * @param {HTMLElement} displayElement - O elemento onde o tempo será exibido.
   */
  function iniciarEstudo(materiaNome, displayElement) {
    // Se já houver um cronômetro ativo para outra matéria, pare-o
    if (activeCronometer.interval && activeCronometer.materiaNome !== materiaNome) {
        showFeedback(`O estudo de "${activeCronometer.materiaNome}" está ativo. Por favor, pause ou conclua-o antes de iniciar outro.`, 'error');
        return;
    }
    // Se o cronômetro já está rodando para esta matéria, não faça nada
    if (activeCronometer.interval && activeCronometer.materiaNome === materiaNome && !activeCronometer.isPaused) {
        return;
    }

    // Limpa qualquer intervalo anterior para evitar duplicação
    clearInterval(activeCronometer.interval);

    // Se estamos iniciando uma nova sessão (não continuando de uma pausa)
    if (activeCronometer.materiaNome !== materiaNome || activeCronometer.pausedTime === 0) {
        activeCronometer.pausedTime = 0; // Zera o tempo acumulado para uma nova sessão
    }

    activeCronometer.materiaNome = materiaNome;
    activeCronometer.displayElement = displayElement;
    activeCronometer.startTime = Date.now();
    activeCronometer.isPaused = false;

    // Atualiza os botões da matéria atual
    const actionsCell = displayElement.parentElement.nextElementSibling;
    actionsCell.querySelector('.start-btn').style.display = 'none';
    actionsCell.querySelector('.pause-btn').style.display = 'inline-block';
    actionsCell.querySelector('.resume-btn').style.display = 'none';
    actionsCell.querySelector('.finish-btn').style.display = 'inline-block';

    // Adiciona classe para destaque visual
    displayElement.classList.remove('paused');
    displayElement.classList.add('active');

    activeCronometer.interval = setInterval(() => {
      const elapsedTime = Date.now() - activeCronometer.startTime + activeCronometer.pausedTime;
      activeCronometer.displayElement.textContent = formatTime(elapsedTime);
    }, 1000);
  }

  /**
   * Pausa o cronômetro para a matéria ativa.
   * @param {string} materiaNome - O nome da matéria.
   */
  function pausarEstudo(materiaNome) {
    if (activeCronometer.materiaNome !== materiaNome || activeCronometer.isPaused) {
        return; // Não é a matéria ativa ou já está pausado
    }

    clearInterval(activeCronometer.interval);
    activeCronometer.interval = null;
    activeCronometer.pausedTime += (Date.now() - activeCronometer.startTime);
    activeCronometer.isPaused = true;

    // Atualiza os botões da matéria atual
    const actionsCell = activeCronometer.displayElement.parentElement.nextElementSibling;
    actionsCell.querySelector('.pause-btn').style.display = 'none';
    actionsCell.querySelector('.resume-btn').style.display = 'inline-block';

    // Adiciona classe para destaque visual de pausado
    activeCronometer.displayElement.classList.remove('active');
    activeCronometer.displayElement.classList.add('paused');
  }

  /**
   * Continua o cronômetro para a matéria ativa.
   * @param {string} materiaNome - O nome da matéria.
   */
  function continuarEstudo(materiaNome) {
    if (activeCronometer.materiaNome !== materiaNome || !activeCronometer.isPaused) {
        return; // Não é a matéria ativa ou não está pausado
    }

    activeCronometer.startTime = Date.now(); // Reinicia o startTime para continuar a contagem
    activeCronometer.isPaused = false;

    // Atualiza os botões da matéria atual
    const actionsCell = activeCronometer.displayElement.parentElement.nextElementSibling;
    actionsCell.querySelector('.pause-btn').style.display = 'inline-block';
    actionsCell.querySelector('.resume-btn').style.display = 'none';

    // Adiciona classe para destaque visual de ativo
    activeCronometer.displayElement.classList.remove('paused');
    activeCronometer.displayElement.classList.add('active');

    activeCronometer.interval = setInterval(() => {
      const elapsedTime = Date.now() - activeCronometer.startTime + activeCronometer.pausedTime;
      activeCronometer.displayElement.textContent = formatTime(elapsedTime);
    }, 1000);
  }

  /**
   * Conclui o estudo para a matéria ativa, salva o tempo e reseta o cronômetro.
   * @param {string} materiaNome - O nome da matéria.
   */
  function concluirEstudo(materiaNome) {
    if (activeCronometer.materiaNome !== materiaNome) {
        return; // Não é a matéria ativa
    }

    clearInterval(activeCronometer.interval);
    activeCronometer.interval = null;

    const totalElapsedTimeMs = activeCronometer.pausedTime + (Date.now() - activeCronometer.startTime);
    const elapsedTimeMinutes = Math.round(totalElapsedTimeMs / (1000 * 60)); // Arredonda para o minuto mais próximo

    const materia = appData.materiasBase.find(m => m.nome === materiaNome);
    if (materia) {
      materia.totalHoras += elapsedTimeMinutes;
      salvarDados();
      showFeedback(`Estudo de "${materiaNome}" concluído! ${elapsedTimeMinutes} min adicionados.`, 'success');
    }

    // Reseta o estado do cronômetro global
    activeCronometer.materiaNome = null;
    activeCronometer.displayElement = null;
    activeCronometer.startTime = 0;
    activeCronometer.pausedTime = 0;
    activeCronometer.isPaused = false;

    // Redesenha a tabela para que os botões voltem ao estado "Iniciar Estudo"
    renderizarHorasTable();
    atualizarGraficos(); // Atualiza gráficos automaticamente
  }

  /**
   * Renderiza a tabela de acertos e erros.
   * Lista apenas as matérias ativas.
   */
  function renderizarQuestoesTable() {
    const tbody = document.querySelector('#questoesTable tbody');
    tbody.innerHTML = '';

    // Filtra apenas as matérias que estão ativas (no cronograma ou com dados)
    const materiasAtivas = appData.materiasBase.filter(materia => {
      const isInCronograma = Object.values(appData.cronogramaSemanal).some(slots =>
        slots.some(slot => slot.materia === materia.nome)
      );
      return isInCronograma || materia.totalHoras > 0 || materia.acertos > 0 || materia.erros > 0;
    });

    materiasAtivas.forEach((materia) => {
      const row = tbody.insertRow();
      row.insertCell().textContent = materia.nome;

      // Input para Acertos com botões de incremento/decremento
      const acertosCell = row.insertCell();
      const acertosContainer = document.createElement('div');
      acertosContainer.className = 'input-with-buttons';
      const acertosInput = document.createElement('input');
      acertosInput.type = 'number';
      acertosInput.min = '0';
      acertosInput.value = materia.acertos;
      acertosInput.addEventListener('change', (e) => {
        materia.acertos = Number(e.target.value);
        salvarDados();
        renderizarQuestoesTable(); // Re-renderiza para atualizar o percentual
        atualizarGraficos(); // Atualiza gráficos automaticamente
      });
      const acertosBtnMinus = document.createElement('button');
      acertosBtnMinus.textContent = '-';
      acertosBtnMinus.onclick = () => { acertosInput.value = Math.max(0, Number(acertosInput.value) - 1); acertosInput.dispatchEvent(new Event('change')); };
      const acertosBtnPlus = document.createElement('button');
      acertosBtnPlus.textContent = '+';
      acertosBtnPlus.onclick = () => { acertosInput.value = Number(acertosInput.value) + 1; acertosInput.dispatchEvent(new Event('change')); };
      acertosContainer.appendChild(acertosBtnMinus);
      acertosContainer.appendChild(acertosInput);
      acertosContainer.appendChild(acertosBtnPlus);
      acertosCell.appendChild(acertosContainer);

      // Input para Erros com botões de incremento/decremento
      const errosCell = row.insertCell();
      const errosContainer = document.createElement('div');
      errosContainer.className = 'input-with-buttons';
      const errosInput = document.createElement('input');
      errosInput.type = 'number';
      errosInput.min = '0';
      errosInput.value = materia.erros;
      errosInput.addEventListener('change', (e) => {
        materia.erros = Number(e.target.value);
        salvarDados();
        renderizarQuestoesTable(); // Re-renderiza para atualizar o percentual
        atualizarGraficos(); // Atualiza gráficos automaticamente
      });
      const errosBtnMinus = document.createElement('button');
      errosBtnMinus.textContent = '-';
      errosBtnMinus.onclick = () => { errosInput.value = Math.max(0, Number(errosInput.value) - 1); errosInput.dispatchEvent(new Event('change')); };
      const errosBtnPlus = document.createElement('button');
      errosBtnPlus.textContent = '+';
      errosBtnPlus.onclick = () => { errosInput.value = Number(errosInput.value) + 1; errosInput.dispatchEvent(new Event('change')); };
      errosContainer.appendChild(errosBtnMinus);
      errosContainer.appendChild(errosInput);
      errosContainer.appendChild(errosBtnPlus);
      errosCell.appendChild(errosContainer);

      // Percentual de Acertos
      const totalQuestoes = materia.acertos + materia.erros;
      const percentual = totalQuestoes > 0 ? ((materia.acertos / totalQuestoes) * 100).toFixed(2) : '0.00';
      const percentualCell = row.insertCell();
      percentualCell.textContent = `${percentual}%`;

      // Adiciona classe de cor base no percentual
      if (percentual >= 80) {
          percentualCell.classList.add('percentual-acertos', 'high');
      } else if (percentual >= 50) {
          percentualCell.classList.add('percentual-acertos', 'medium');
      } else {
          percentualCell.classList.add('percentual-acertos', 'low');
      }
    });
  }

  /**
   * Adiciona uma nova matéria à lista de matérias base.
   */
  function adicionarMateriaBase() {
    const novaMateriaNomeInput = document.getElementById('novaMateriaNome');
    const nome = novaMateriaNomeInput.value.trim();

    if (nome) {
      if (!appData.materiasBase.some(m => m.nome.toLowerCase() === nome.toLowerCase())) {
        appData.materiasBase.push({
          nome: nome,
          totalHoras: 0,
          acertos: 0,
          erros: 0
        });
        novaMateriaNomeInput.value = ''; // Limpa o input
        salvarDados();
        renderizarTabelas(); // Re-renderiza todas as tabelas
        renderizarMateriasModalList(); // Atualiza a lista de matérias no modal
        atualizarGraficos();
        showFeedback(`Matéria "${nome}" adicionada com sucesso!`, 'success', 'materiaFeedback');
      } else {
        showFeedback('Matéria já existe!', 'error', 'materiaFeedback');
      }
    } else {
      showFeedback('Por favor, digite o nome da matéria.', 'error', 'materiaFeedback');
    }
  }

  /**
   * Remove uma matéria da lista de matérias base e de todos os cronogramas.
   * @param {string} materiaNome - O nome da matéria a ser removida.
   */
  function removerMateriaBase(materiaNome) {
    if (confirm(`Tem certeza que deseja remover a matéria "${materiaNome}"? Isso removerá todos os dados associados.`)) {
      // Se a matéria a ser removida é a que está com o cronômetro ativo, conclua-o
      if (activeCronometer.materiaNome === materiaNome) {
          concluirEstudo(materiaNome); // Conclui para salvar o tempo antes de remover
      }

      // Remove da lista de matérias base
      appData.materiasBase = appData.materiasBase.filter(m => m.nome !== materiaNome);

      // Remove de todos os slots do cronograma
      Object.keys(appData.cronogramaSemanal).forEach(dia => {
        appData.cronogramaSemanal[dia] = appData.cronogramaSemanal[dia].filter(slot => slot.materia !== materiaNome);
      });

      salvarDados();
      renderizarTabelas();
      renderizarMateriasModalList(); // Atualiza a lista de matérias no modal
      atualizarGraficos();
      showFeedback(`Matéria "${materiaNome}" removida com sucesso!`, 'success', 'materiaFeedback');
    }
  }

  /**
   * Renderiza todas as tabelas.
   */
  function renderizarTabelas() {
    renderizarCronograma();
    renderizarHorasTable();
    renderizarQuestoesTable();
  }

  /**
   * Atualiza os gráficos com os dados atuais.
   */
  function atualizarGraficos() {
    // Os gráficos agora devem incluir apenas as matérias ativas
    const materiasAtivas = appData.materiasBase.filter(materia => {
      const isInCronograma = Object.values(appData.cronogramaSemanal).some(slots =>
        slots.some(slot => slot.materia === materia.nome)
      );
      return isInCronograma || materia.totalHoras > 0 || materia.acertos > 0 || materia.erros > 0;
    });

    const materiasLabels = materiasAtivas.map(m => m.nome);
    const horasData = materiasAtivas.map(m => m.totalHoras); // Total de minutos
    const acertosData = materiasAtivas.map(m => m.acertos);
    const errosData = materiasAtivas.map(m => m.erros);

    // Atualiza gráfico de horas
    if (chartHoras) chartHoras.destroy();
    chartHoras = new Chart(document.getElementById('chartHoras'), {
      type: 'bar',
      data: {
        labels: materiasLabels,
        datasets: [{
          label: 'Total de Horas (minutos)',
          data: horasData,
          backgroundColor: '#e94560',
          borderColor: '#c23a50',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#e0e0e0' },
            grid: { color: '#2e2e4a' }
          },
          x: {
            ticks: { color: '#e0e0e0' },
            grid: { color: '#2e2e4a' }
          }
        },
        plugins: {
          legend: { labels: { color: '#e0e0e0' } },
          tooltip: { // Configuração de tooltip
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += context.parsed.y + ' min';
                }
                return label;
              }
            }
          }
        }
      }
    });

    // Atualiza gráfico de acertos x erros
    if (chartQuestoes) chartQuestoes.destroy();
    chartQuestoes = new Chart(document.getElementById('chartQuestoes'), {
      type: 'bar',
      data: {
        labels: materiasLabels,
        datasets: [
          { label: 'Acertos', data: acertosData, backgroundColor: '#66bb6a', borderColor: '#4caf50', borderWidth: 1 },
          { label: 'Erros', data: errosData, backgroundColor: '#ef5350', borderColor: '#f44336', borderWidth: 1 }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#e0e0e0' },
            grid: { color: '#2e2e4a' }
          },
          x: {
            ticks: { color: '#e0e0e0' },
            grid: { color: '#2e2e4a' }
          }
        },
        plugins: {
          legend: { labels: { color: '#e0e0e0' } },
          tooltip: { // Configuração de tooltip
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += context.parsed.y + ' questões';
                }
                return label;
              }
            }
          }
        }
      }
    });
  }

  // Adicionado: Função para controle das abas
  function showTab(tabId, clickedButton) {
    // Apenas executa a lógica de abas se a tela for pequena (mobile/tablet)
    if (window.matchMedia("(max-width: 768px)").matches) {
      // Esconder todos os conteúdos das abas
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });

      // Remover a classe 'active' de todos os botões de navegação
      document.querySelectorAll('.tab-navigation button').forEach(button => {
        button.classList.remove('active');
      });

      // Mostrar o conteúdo da aba clicada
      document.getElementById(tabId).classList.add('active');

      // Adicionar a classe 'active' ao botão clicado
      if (clickedButton) {
        clickedButton.classList.add('active');
      }

      // Se a aba de gráficos for ativada, garantir que os gráficos sejam atualizados/renderizados
      if (tabId === 'graficosTab') {
        atualizarGraficos();
      }
    }
  }

  /**
   * Salva o progresso atual em um arquivo JSON e o baixa.
   */
  function salvarProgressoJSON() {
    const dataToSave = JSON.stringify(appData, null, 2); // Formata com 2 espaços para legibilidade
    const blob = new Blob([dataToSave], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'planilha_estudo_progresso.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showFeedback('Progresso salvo com sucesso!', 'success', 'dataFeedback');
  }

  /**
   * Carrega o progresso de um arquivo JSON selecionado pelo usuário.
   * @param {Event} event - O evento de mudança do input de arquivo.
   */
  function carregarProgressoJSON(event) {
    const file = event.target.files[0];
    if (!file) {
      showFeedback('Nenhum arquivo selecionado.', 'error', 'dataFeedback');
      return;
    }

    if (file.type !== 'application/json') {
      showFeedback('Por favor, selecione um arquivo JSON válido.', 'error', 'dataFeedback');
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const loadedData = JSON.parse(e.target.result);

        // Validação básica da estrutura do JSON carregado
        if (loadedData.materiasBase && Array.isArray(loadedData.materiasBase) &&
            loadedData.cronogramaSemanal && typeof loadedData.cronogramaSemanal === 'object') {

          // Confirmação antes de sobrescrever
          if (!confirm('Tem certeza que deseja carregar este progresso? O progresso atual será substituído.')) {
            showFeedback('Carregamento cancelado.', 'error', 'dataFeedback');
            return;
          }

          appData = loadedData; // Substitui os dados atuais pelos carregados
          salvarDados(); // Salva os novos dados no localStorage
          renderizarTabelas(); // Re-renderiza a UI com os novos dados
          atualizarGraficos(); // Atualiza os gráficos
          showFeedback('Progresso carregado com sucesso!', 'success', 'dataFeedback');
        } else {
          showFeedback('Estrutura do arquivo JSON inválida. Certifique-se de que é um arquivo de progresso válido.', 'error', 'dataFeedback');
        }
      } catch (error) {
        console.error('Erro ao parsear JSON:', error);
        showFeedback('Erro ao carregar o arquivo JSON. Verifique o formato.', 'error', 'dataFeedback');
      } finally {
        // Limpa o input de arquivo para permitir o carregamento do mesmo arquivo novamente
        event.target.value = '';
      }
    };
    reader.readAsText(file);
  }


  // Inicialização: Carrega dados, renderiza tabelas e gráficos ao carregar a página
  document.addEventListener('DOMContentLoaded', () => {
    carregarDados();
    renderizarTabelas();
    atualizarGraficos();

    // Lógica para ativar a primeira aba e seu botão correspondente APENAS em mobile/tablet
    if (window.matchMedia("(max-width: 768px)").matches) {
      const firstTabButton = document.getElementById('tabBtnMaterias'); // Usar ID para garantir o botão correto
      if (firstTabButton) {
        showTab('materiasTab', firstTabButton);
      }
    }
  });
</script>
</body>
</html>
